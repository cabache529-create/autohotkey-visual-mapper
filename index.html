<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AutoHotKey v2 „É¨„Ç§„É§„Éº„Ç≠„Éº„Éû„ÉÉ„Éó„Ç®„Éá„Ç£„Çø - SendEventÁâàÔºà„Ç≠„ÉºÊºè„ÇåÈò≤Ê≠¢Ôºâ</title>
  <style>

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Meiryo', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      padding-top: 190px;
    }
    
    .fixed-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      padding: 15px 20px;
    }
    
    .fixed-header-content {
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Ë®ÄË™ûÂàáÊõø„Éú„Çø„É≥ */
    .lang-toggle {
      position: absolute;
      top: 15px;
      right: 20px;
      background: #667eea;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.3s;
      z-index: 10;
    }
    
    .lang-toggle:hover {
      background: #5568d3;
      transform: translateY(-1px);
    }

    /* „É¨„Ç§„É§„Éº„Çø„Éñ */
    .layer-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .layer-tab {
      padding: 8px 15px;
      background: #f5f5f5;
      border: 2px solid #ddd;
      border-radius: 6px 6px 0 0;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 600;
    }

    .layer-tab.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .layer-tab:hover:not(.active) {
      background: #e8e8e8;
    }

    .layer-tab .layer-key-badge {
      background: #ffd93d;
      color: #000;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 700;
    }

    .layer-tab.active .layer-key-badge {
      background: #fff;
      color: #667eea;
    }

    .layer-tab .delete-layer {
      margin-left: 5px;
      color: #ff4444;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
    }

    .layer-tab.active .delete-layer {
      color: #ffcccc;
    }

    .add-layer-btn {
      padding: 8px 15px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: background 0.3s;
    }

    .add-layer-btn:hover {
      background: #45a049;
    }

    /* „É¨„Ç§„É§„ÉºË®≠ÂÆö„Éë„Éç„É´ */
    .layer-settings {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
    }

    .layer-settings h3 {
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
    }

    .setting-row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 8px;
    }

    .setting-row label {
      min-width: 110px;
      font-weight: 600;
      font-size: 13px;
    }

    .setting-row input,
    .setting-row select {
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      flex: 1;
    }

    /* ÈÅ∏ÊäûË°åÔºà‰∏ÄË°å„É¨„Ç§„Ç¢„Ç¶„ÉàÔºâ */
    .selection-row {
      display: flex;
      column-gap: 150px;
      row-gap: 10px;
      margin-bottom: 0;
      align-items: center;
      flex-wrap: wrap;
    }

    .selection-group {
      display: flex;
      gap: 10px;
      align-items: center;
      min-width: 400px;
    }

    .inline-selection {
      display: flex;
      gap: 8px;
      align-items: center;
      flex: 1;
    }

    .inline-label {
      font-weight: 700;
      color: #2d3748;
      font-size: 13px;
      min-width: 60px;
    }

    .mode-btn {
      padding: 8px 16px;
      border: 2px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .mode-btn:hover {
      background: #f5f5f5;
    }

    .mode-btn.active-input {
      background: #60a5fa;
      color: white;
      border-color: #60a5fa;
    }

    .mode-btn.active-output {
      background: #f472b6;
      color: white;
      border-color: #f472b6;
    }
    
    .current-selection {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      min-height: 32px;
      padding: 6px 10px;
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 5px;
      font-size: 13px;
      max-width: 300px;
      min-width: 200px;
    }
    
    .current-selection.input-mode {
      border-color: #60a5fa;
      background: #eff6ff;
    }
    
    .current-selection.output-mode {
      border-color: #f472b6;
      background: #fdf2f8;
    }
    
    .selection-tag {
      background: #cbd5e0;
      color: #2d3748;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .selection-tag.input {
      background: #60a5fa;
      color: white;
    }
    
    .selection-tag.output {
      background: #f472b6;
      color: white;
    }

    /* „É¨„Ç§„É§„Éº„Çø„Éñ */
    .layer-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .layer-tab {
      padding: 10px 20px;
      background: #f5f5f5;
      border: 2px solid #ddd;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
    }

    .layer-tab.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .layer-tab:hover:not(.active) {
      background: #e8e8e8;
    }

    .layer-tab .layer-key-badge {
      background: #ffd93d;
      color: #000;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
    }

    .layer-tab.active .layer-key-badge {
      background: #fff;
      color: #667eea;
    }

    .layer-tab .delete-layer {
      margin-left: 5px;
      color: #ff4444;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
    }

    .layer-tab.active .delete-layer {
      color: #ffcccc;
    }

    .add-layer-btn {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.3s;
    }

    .add-layer-btn:hover {
      background: #45a049;
    }

    /* „É¨„Ç§„É§„ÉºË®≠ÂÆö„Éë„Éç„É´ */
    .layer-settings {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .layer-settings h3 {
      margin-bottom: 10px;
      color: #333;
      font-size: 16px;
    }

    .setting-row {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 10px;
    }

    .setting-row label {
      min-width: 120px;
      font-weight: 600;
      font-size: 14px;
    }

    .setting-row input,
    .setting-row select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      flex: 1;
    }

    /* ÁâπÊÆä„Ç¢„ÇØ„Ç∑„Éß„É≥„Éë„Éç„É´ */
    .special-actions {
      background: #fff3cd;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border: 2px solid #ffc107;
    }

    .special-actions h4 {
      margin-bottom: 10px;
      color: #856404;
      font-size: 14px;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 8px 15px;
      background: #ffc107;
      color: #000;
      border: 2px solid #ffb300;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: #ffb300;
      transform: translateY(-2px);
    }

    .action-btn.selected {
      background: #ff9800;
      border-color: #f57c00;
    }
    
    .header-row {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .header-section {
      flex: 1;
      min-width: 300px;
    }
    
    .header-label {
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .current-selection {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      min-height: 36px;
      padding: 8px 12px;
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
    }
    
    .current-selection.input-mode {
      border-color: #60a5fa;
      background: #eff6ff;
    }
    
    .current-selection.output-mode {
      border-color: #f472b6;
      background: #fdf2f8;
    }
    
    .selection-tag {
      background: #cbd5e0;
      color: #2d3748;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .selection-tag.input {
      background: #60a5fa;
      color: white;
    }
    
    .selection-tag.output {
      background: #f472b6;
      color: white;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 30px;
    }

    h1 {
      color: #333;
      margin-bottom: 30px;
      text-align: center;
      font-size: 2em;
    }

    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      align-items: center;
    }

    .control-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    label {
      font-weight: 600;
      color: #555;
    }

    select, button, input[type="file"] {
      padding: 10px 20px;
      border-radius: 6px;
      border: 2px solid #ddd;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    select {
      background: white;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      font-weight: 600;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .keyboard-container {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 30px;
      overflow-x: auto;
      overflow-y: visible;
    }

    .keyboard {
      position: relative;
      min-width: 1300px;
      height: auto;
      min-height: 400px;
    }

    .key {
      position: absolute;
      background: linear-gradient(180deg, #ffffff 0%, #e9ecef 100%);
      border: 2px solid #adb5bd;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      color: #333;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 4px;
    }

    .key:hover {
      background: linear-gradient(180deg, #e7f3ff 0%, #cfe2ff 100%);
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    .key.selected {
      background: linear-gradient(180deg, #ffd700 0%, #ffa500 100%);
      color: #000;
      border-color: #ff8c00;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.6);
      font-weight: 800;
    }

    .key.mapped {
      background: linear-gradient(180deg, #48bb78 0%, #38a169 100%);
      color: white;
      border-color: #2f855a;
    }
    
    .key.input-selected {
      background: linear-gradient(180deg, #60a5fa 0%, #3b82f6 100%);
      color: white;
      border-color: #2563eb;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.6);
      font-weight: 800;
    }
    
    .key.output-selected {
      background: linear-gradient(180deg, #f472b6 0%, #ec4899 100%);
      color: white;
      border-color: #db2777;
      box-shadow: 0 4px 12px rgba(236, 72, 153, 0.6);
      font-weight: 800;
    }

    .key.layer-key {
      background: linear-gradient(180deg, #ffd93d 0%, #f9c74f 100%);
      border-color: #ffd93d;
      color: #000;
      font-weight: 800;
    }

    .key-main-label {
      font-size: 12px;
      font-weight: 700;
    }

    .key-sub-label {
      font-size: 9px;
      color: #666;
      margin-top: 2px;
    }

    .key.mapped .key-sub-label,
    .key.input-selected .key-sub-label,
    .key.output-selected .key-sub-label,
    .key.layer-key .key-sub-label {
      color: rgba(255,255,255,0.8);
    }

    .mappings-section {
      margin-top: 30px;
    }

    .mappings-section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.5em;
    }
    
    .selection-mode {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: #e7f3ff;
      border-radius: 8px;
      align-items: center;
    }
    
    .selection-mode label {
      font-weight: 600;
      color: #333;
      margin-right: 5px;
    }
    
    .mode-btn {
      padding: 10px 20px;
      border: 2px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .mode-btn:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .mode-btn.active-input {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      color: white;
      border-color: #2563eb;
    }
    
    .mode-btn.active-output {
      background: linear-gradient(135deg, #fda4af 0%, #fb7185 100%);
      color: white;
      border-color: #f43f5e;
    }
    
    /* Âá∫Âäõ„É¢„Éº„Éâ„Éú„Çø„É≥„ÅÆ„Éá„Éï„Ç©„É´„Éà„Çπ„Çø„Ç§„É´ */
    #outputModeBtn {
      background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
      color: #831843;
      border-color: #f9a8d4;
      font-weight: 700;
    }
    
    #outputModeBtn:hover {
      background: linear-gradient(135deg, #fbcfe8 0%, #f9a8d4 100%);
      border-color: #f472b6;
    }

    .mapping-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .form-group {
      flex: 1;
      min-width: 200px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }

    .modifier-checkboxes {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .modifier-checkboxes label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      font-weight: normal;
    }

    .modifier-checkboxes input[type="checkbox"] {
      cursor: pointer;
    }

    .mapping-list {
      list-style: none;
    }

    .mapping-item {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .mapping-info {
      flex: 1;
    }

    .mapping-keys {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .mapping-arrow {
      color: #667eea;
      margin: 0 10px;
    }

    .delete-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .delete-btn:hover {
      background: #ee5a6f;
      transform: scale(1.05);
    }

    #ahkOutput {
      background: #2a2a2a;
      color: #0f0;
      padding: 20px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      max-height: 500px;
      overflow-y: auto;
      margin-top: 20px;
      border: 2px solid #444;
    }

    .output-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
  

    /* Âá∫ÂäõÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ */
    .output-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
      padding: 20px;
    }

    .output-modal.active {
      display: flex;
    }

    .output-modal-content {
      background: white;
      border-radius: 15px;
      max-width: 900px;
      width: 95%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .output-modal-header {
      padding: 20px 25px;
      border-bottom: 2px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px 15px 0 0;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .output-modal-header h2 {
      margin: 0;
      font-size: 22px;
    }

    .output-modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      line-height: 1;
    }

    .output-modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .output-modal-body {
      padding: 25px;
    }

    .modal-section {
      margin-bottom: 25px;
    }

    .modal-section h3 {
      margin: 0 0 15px 0;
      font-size: 16px;
      color: #333;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
    }

    .modal-key-item {
      padding: 12px 8px;
      background: linear-gradient(180deg, #ffffff 0%, #f5f5f5 100%);
      border: 2px solid #ddd;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 50px;
    }

    .modal-key-item:hover {
      background: linear-gradient(180deg, #e7f3ff 0%, #cfe2ff 100%);
      border-color: #667eea;
      transform: translateY(-2px);
    }

    .modal-key-item.selected {
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      border-color: #667eea;
      color: white;
    }

    .output-modal-footer {
      padding: 15px 25px;
      border-top: 2px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f9f9f9;
      border-radius: 0 0 15px 15px;
      position: sticky;
      bottom: 0;
      z-index: 10;
    }

    .output-preview {
      flex: 1;
      padding: 12px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 6px;
      margin-right: 15px;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      min-height: 40px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 5px;
    }

    .output-preview.empty {
      color: #999;
      font-weight: normal;
    }

    .modal-btn {
      padding: 10px 25px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: 10px;
    }

    .modal-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .modal-btn-secondary {
      background: #f5f5f5;
      color: #666;
    }

    .modal-btn-secondary:hover {
      background: #e8e8e8;
    }
  
    /* „Ç´„Çπ„Çø„É†ÊñáÂ≠óÂàóÁÆ°ÁêÜ */
    .custom-string-item {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
      background: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
    }

    .custom-string-item input {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
    }

    .custom-string-item input:focus {
      outline: none;
      border-color: #667eea;
    }

    .custom-string-item .delete-string {
      background: #ef4444;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: background 0.2s;
      min-width: 60px;
    }

    .custom-string-item .delete-string:hover {
      background: #dc2626;
    }

    .modal-key-item.language-switch {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-color: #3b82f6;
    }

    .modal-key-item.language-switch.selected {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border-color: #1d4ed8;
    }

    .modal-key-item.custom-string {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-color: #f59e0b;
      font-size: 11px;
      word-break: break-all;
    }

    .modal-key-item.custom-string.selected {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      border-color: #b45309;
    }
</style>
</head>
<body>
  <div class="fixed-header">
    <div class="fixed-header-content">
      <!-- Ë®ÄË™ûÂàáÊõø„Éú„Çø„É≥ -->
      <button class="lang-toggle" onclick="toggleLanguage()">
        üåê <span id="langBtn">JA</span>
      </button>
      
      <!-- „É¨„Ç§„É§„Éº„Çø„Éñ -->
      <div class="layer-tabs" id="layerTabs">
        <!-- JavaScript„ÅßÂãïÁöÑÁîüÊàê -->
      </div>

      <!-- „É¨„Ç§„É§„ÉºË®≠ÂÆö -->
      <div class="layer-settings" id="layerSettings">
        <h3 id="layerSettingsTitle">„É¨„Ç§„É§„ÉºË®≠ÂÆö</h3>
        <div class="setting-row">
          <label id="labelLayout">„Ç≠„Éº„Éú„Éº„ÉâÈÖçÂàó:</label>
          <select id="keyboardLayoutSelect" onchange="changeKeyboardLayout()">
            <option value="us">USÈÖçÂàó</option>
            <option value="jis">Êó•Êú¨Ë™ûÈÖçÂàó (JIS)</option>
          </select>
        </div>
        <div class="setting-row">
          <label id="labelLayerName">„É¨„Ç§„É§„ÉºÂêç:</label>
          <input type="text" id="layerName" placeholder="„É¨„Ç§„É§„ÉºÂêç„ÇíÂÖ•Âäõ">
        </div>
        <div class="setting-row" id="layerKeyRow" style="display: none;">
          <label id="labelKey">„É¨„Ç§„É§„Éº„Ç≠„Éº:</label>
          <select id="layerKeySelect">
            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
          </select>
        </div>
      </div>

      <!-- ÈÅ∏Êäû„É¢„Éº„Éâ„Å®ÁèæÂú®„ÅÆÈÅ∏ÊäûÔºà‰∏ÄË°åÔºâ -->
      <div class="selection-row">
        <div class="selection-group">
          <button id="inputModeBtn" class="mode-btn active-input" onclick="setSelectionMode('input')">ÂÖ•Âäõ„Ç≠„ÉºÈÅ∏Êäû</button>
          <div class="inline-selection">
            <div class="inline-label" id="labelInputKeys">ÂÖ•Âäõ„Ç≠„Éº</div>
            <div id="inputKeysDisplay" class="current-selection input-mode">
              <span style="color: #999;">„Ç≠„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
            </div>
          </div>
        </div>
        <div class="selection-group">
          <button id="outputModeBtn" class="mode-btn" onclick="openOutputModal()">Âá∫Âäõ„Ç≠„ÉºÈÅ∏Êäû („É¢„Éº„ÉÄ„É´)</button>
          <div class="inline-selection">
            <div class="inline-label" id="labelOutputKeys">Âá∫Âäõ„Ç≠„Éº</div>
            <div id="outputKeysDisplay" class="current-selection output-mode">
              <span style="color: #999;">„Ç≠„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- „Ç≠„Éº„Éú„Éº„Éâ„É¨„Ç§„Ç¢„Ç¶„Éà -->
    <div class="keyboard-container">
      <div class="keyboard" id="keyboard">
        <!-- JavaScript„ÅßÂãïÁöÑÁîüÊàê -->
      </div>
    </div>

    <!-- „Éû„ÉÉ„Éî„É≥„Ç∞Âà∂Âæ° -->
    <div class="controls">
      <div style="flex: 1; padding: 10px 0; color: #666; font-size: 14px;" id="usageHint">
        üí° <strong>‰Ωø„ÅÑÊñπ:</strong> ÂÖ•Âäõ„Ç≠„Éº„ÇíÈÅ∏Êäû ‚Üí „ÄåÂá∫Âäõ„Ç≠„ÉºÈÅ∏Êäû„Äç„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅÑ„Å¶Âá∫Âäõ„ÇíÈÅ∏Êäû ‚Üí „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆ„Äå„Éû„ÉÉ„Éî„É≥„Ç∞ËøΩÂä†„Äç„Éú„Çø„É≥„ÅßÁôªÈå≤
      </div>
      <button onclick="clearSelection()" id="btnClearSelection">üîÑ ÈÅ∏Êäû„ÇØ„É™„Ç¢</button>
      <button onclick="clearAllMappings()" style="background: #ff6b6b;" id="btnClearAllMappings">üóëÔ∏è ÂÖ®„Éû„ÉÉ„Éî„É≥„Ç∞„ÇØ„É™„Ç¢</button>
    </div>

    <!-- „Éû„ÉÉ„Éî„É≥„Ç∞„É™„Çπ„Éà -->
    <div class="mappings-section">
      <h2 id="mappingListTitle">„Éû„ÉÉ„Éî„É≥„Ç∞‰∏ÄË¶ß</h2>
      <ul id="mappingList" class="mapping-list">
        <!-- JavaScript„ÅßÂãïÁöÑÁîüÊàê -->
      </ul>
    </div>

    <!-- AHKÂá∫Âäõ -->
    <div class="mappings-section">
      <h2 id="ahkScriptTitle">AutoHotkey v2 „Çπ„ÇØ„É™„Éó„Éà</h2>
      <pre id="ahkOutput"></pre>
      <div class="output-controls">
        <button onclick="downloadAHK()" id="downloadBtn">üíæ AHKv2„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
        <button onclick="saveJSON()" id="saveBtn">üìÅ Ë®≠ÂÆö‰øùÂ≠ò (.json)</button>
        <label style="background: #4CAF50; cursor: pointer; padding: 10px 20px; border-radius: 6px; color: white; font-weight: 600;" id="loadBtn">
          üìÇ Ë®≠ÂÆöË™≠Ëæº (.json)
          <input type="file" accept=".json" onchange="loadJSON(event)" style="display: none;">
        </label>
      </div>
    </div>
  </div>


  <!-- Âá∫ÂäõÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
  <div class="output-modal" id="outputModal">
    <div class="output-modal-content">
      <div class="output-modal-header">
        <h2>üéØ Âá∫Âäõ„Ç≠„ÉºÈÅ∏Êäû</h2>
        <button class="output-modal-close" onclick="closeOutputModal()">√ó</button>
      </div>
      
      <div class="output-modal-body">
        <!-- ‰øÆÈ£æ„Ç≠„Éº -->
        <div class="modal-section">
          <h3>üéõÔ∏è ‰øÆÈ£æ„Ç≠„Éº</h3>
          <div class="modal-grid" style="grid-template-columns: repeat(4, 1fr);" id="modifierModalGrid"></div>
        </div>

        <!-- „Ç≠„Éº„Éú„Éº„ÉâÔºàË°å„Åî„Å®„Å´Êï¥ÁêÜÔºâ -->
        <div class="modal-section">
          <h3>‚å®Ô∏è „Ç≠„Éº„Éú„Éº„Éâ</h3>
          
          <!-- „Éï„Ç°„É≥„ÇØ„Ç∑„Éß„É≥„Ç≠„Éº -->
          <div style="margin-bottom: 15px;">
            <h4 style="font-size: 13px; color: #666; margin-bottom: 8px;">„Éï„Ç°„É≥„ÇØ„Ç∑„Éß„É≥„Ç≠„Éº</h4>
            <div class="modal-grid" id="functionKeysGrid"></div>
          </div>
          
          <!-- Êï∞Â≠ó„ÉªË®òÂè∑ -->
          <div style="margin-bottom: 15px;">
            <h4 style="font-size: 13px; color: #666; margin-bottom: 8px;">Êï∞Â≠ó„ÉªË®òÂè∑</h4>
            <div class="modal-grid" id="numberKeysGrid"></div>
          </div>
          
          <!-- „Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà -->
          <div style="margin-bottom: 15px;">
            <h4 style="font-size: 13px; color: #666; margin-bottom: 8px;">„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà</h4>
            <div class="modal-grid" id="letterKeysGrid"></div>
          </div>
          
          <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
          <div style="margin-bottom: 15px;">
            <h4 style="font-size: 13px; color: #666; margin-bottom: 8px;">„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„ÉªÁ∑®ÈõÜ</h4>
            <div class="modal-grid" id="navKeysGrid"></div>
          </div>
          
          <!-- „ÉÜ„É≥„Ç≠„Éº -->
          <div style="margin-bottom: 15px;">
            <h4 style="font-size: 13px; color: #666; margin-bottom: 8px;">„ÉÜ„É≥„Ç≠„Éº</h4>
            <div class="modal-grid" id="numpadKeysGrid"></div>
          </div>
        </div>

        <!-- „Éû„Ç¶„Çπ -->
        <div class="modal-section">
          <h3>üñ±Ô∏è „Éû„Ç¶„Çπ</h3>
          <div class="modal-grid" id="mouseModalGrid"></div>
        </div>

        <!-- „É°„Éá„Ç£„Ç¢„Éª„Éñ„É©„Ç¶„Ç∂ -->
        <div class="modal-section">
          <h3>üéµ „É°„Éá„Ç£„Ç¢„Éª„Éñ„É©„Ç¶„Ç∂</h3>
          <div class="modal-grid" id="mediaModalGrid"></div>
        </div>

        <!-- ÁâπÊÆä -->
        <div class="modal-section">
          <h3>‚ö° ÁâπÊÆä</h3>
          <div class="modal-grid" id="specialModalGrid"></div>
        </div>

        <!-- Ë®ÄË™ûÂàá„ÇäÊõø„Åà -->
        <div class="modal-section">
          <h3>üåê Ë®ÄË™ûÂàá„ÇäÊõø„Åà</h3>
          <div class="modal-grid" id="languageSwitchGrid"></div>
        </div>

        <!-- „Ç´„Çπ„Çø„É†ÊñáÂ≠óÂàó -->
        <div class="modal-section">
          <h3>üìù „Ç´„Çπ„Çø„É†ÊñáÂ≠óÂàó</h3>
          <div style="margin-bottom: 15px;">
            <button class="modal-btn modal-btn-primary" style="font-size: 13px; padding: 8px 16px;" onclick="addCustomString()">+ Êñ∞„Åó„ÅÑÊñáÂ≠óÂàó„ÇíËøΩÂä†</button>
          </div>
          <div id="customStringsList" style="margin-bottom: 15px;"></div>
          <div class="modal-grid" id="customStringsGrid"></div>
        </div>
      </div>

      <div class="output-modal-footer">
        <div id="outputPreview" class="output-preview empty">
          ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì
        </div>
        <div>
          <button class="modal-btn modal-btn-secondary" onclick="clearModalSelection()">üîÑ „ÇØ„É™„Ç¢</button>
          <button class="modal-btn modal-btn-primary" onclick="confirmAndAddMapping()">‚úÖ „Éû„ÉÉ„Éî„É≥„Ç∞ËøΩÂä†</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Ë®ÄË™ûÂàá„ÇäÊõø„Åà„Å®„Ç´„Çπ„Çø„É†ÊñáÂ≠óÂàó„ÅÆÊ©üËÉΩ =====
    
    // Ë®ÄË™ûÂàá„ÇäÊõø„Åà„Ç¢„ÇØ„Ç∑„Éß„É≥ÂÆöÁæ©
    const languageSwitchActions = [
      { code: 'IME_Japanese', label: 'Êó•Êú¨Ë™û„Å´Âàá„ÇäÊõø„Åà', ahk: 'SendEvent("{vkF2}")' },
      { code: 'IME_English', label: 'Ëã±Ë™û„Å´Âàá„ÇäÊõø„Åà', ahk: 'SendEvent("{vkF3}")' }
    ];

    // „Ç´„Çπ„Çø„É†ÊñáÂ≠óÂàó„ÅÆ„Éá„Éº„Çø
    let customStrings = [];
    let nextCustomStringId = 1;

    // „Ç´„Çπ„Çø„É†ÊñáÂ≠óÂàó„ÇíËøΩÂä†
    function addCustomString() {
      const id = nextCustomStringId++;
      const customString = {
        id: id,
        label: '',
        value: '',
        code: `Custom_String_${id}`
      };
      customStrings.push(customString);
      renderCustomStrings();
      renderCustomStringsGrid();
    }

    // „Ç´„Çπ„Çø„É†ÊñáÂ≠óÂàó„ÇíÂâäÈô§
    function deleteCustomString(id) {
      customStrings = customStrings.filter(s => s.id !== id);
      // ‰ΩøÁî®‰∏≠„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞„Åã„ÇâÂâäÈô§
      const code = `Custom_String_${id}`;
      outputKeys = outputKeys.filter(k => k !== code);
      renderCustomStrings();
      renderCustomStringsGrid();
    }

    // „Ç´„Çπ„Çø„É†ÊñáÂ≠óÂàó„ÅÆ„É©„Éô„É´„ÇíÊõ¥Êñ∞
    function updateCustomStringLabel(id, label) {
      const str = customStrings.find(s => s.id === id);
      if (str) {
        str.label = label;
        renderCustomStringsGrid();
      }
    }

    // „Ç´„Çπ„Çø„É†ÊñáÂ≠óÂàó„ÅÆÂÄ§„ÇíÊõ¥Êñ∞
    function updateCustomStringValue(id, value) {
      const str = customStrings.find(s => s.id === id);
      if (str) {
        str.value = value;
      }
    }

    // „Ç´„Çπ„Çø„É†ÊñáÂ≠óÂàó„É™„Çπ„Éà„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
    function renderCustomStrings() {
      const container = document.getElementById('customStringsList');
      container.innerHTML = '';
      
      if (customStrings.length === 0) {
        container.innerHTML = '<p style="color: #999; font-size: 13px; text-align: center;">ÊñáÂ≠óÂàó„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
        return;
      }
      
      customStrings.forEach(str => {
        const item = document.createElement('div');
        item.className = 'custom-string-item';
        
        const labelInput = document.createElement('input');
        labelInput.type = 'text';
        labelInput.placeholder = '„É©„Éô„É´ (‰æã: „Éë„Çπ„ÉØ„Éº„Éâ1)';
        labelInput.value = str.label;
        labelInput.style.maxWidth = '200px';
        labelInput.oninput = (e) => updateCustomStringLabel(str.id, e.target.value);
        
        const valueInput = document.createElement('input');
        valueInput.type = 'text';
        valueInput.placeholder = 'ÈÄÅ‰ø°„Åô„ÇãÊñáÂ≠óÂàó';
        valueInput.value = str.value;
        valueInput.oninput = (e) => updateCustomStringValue(str.id, e.target.value);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-string';
        deleteBtn.textContent = 'ÂâäÈô§';
        deleteBtn.onclick = () => {
          if (confirm('„Åì„ÅÆÊñáÂ≠óÂàó„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
            deleteCustomString(str.id);
          }
        };
        
        item.appendChild(labelInput);
        item.appendChild(valueInput);
        item.appendChild(deleteBtn);
        container.appendChild(item);
      });
    }

    // „Ç´„Çπ„Çø„É†ÊñáÂ≠óÂàó„Ç∞„É™„ÉÉ„Éâ„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
    function renderCustomStringsGrid() {
      const grid = document.getElementById('customStringsGrid');
      if (!grid) return;
      grid.innerHTML = '';
      
      if (customStrings.length === 0) {
        return;
      }
      
      customStrings.forEach(str => {
        const key = document.createElement('div');
        key.className = 'modal-key-item custom-string';
        key.textContent = str.label || `ÊñáÂ≠óÂàó ${str.id}`;
        key.dataset.code = str.code;
        
        if (tempOutputKeys.includes(str.code)) {
          key.classList.add('selected');
        }
        
        key.onclick = () => {
          toggleModalKey(str.code);
        };
        
        grid.appendChild(key);
      });
    }

    // Ë®ÄË™ûÂàá„ÇäÊõø„Åà„Ç∞„É™„ÉÉ„Éâ„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
    function renderLanguageSwitchGrid() {
      const grid = document.getElementById('languageSwitchGrid');
      if (!grid) return;
      grid.innerHTML = '';
      
      languageSwitchActions.forEach(action => {
        const key = document.createElement('div');
        key.className = 'modal-key-item language-switch';
        key.textContent = action.label;
        key.dataset.code = action.code;
        
        if (tempOutputKeys.includes(action.code)) {
          key.classList.add('selected');
        }
        
        key.onclick = () => {
          toggleModalKey(action.code);
        };
        
        grid.appendChild(key);
      });
    }

    // ===== Êó¢Â≠òÈñ¢Êï∞„ÅÆÊã°Âºµ =====


    // „Éê„Éº„Ç∏„Éß„É≥ÁÆ°ÁêÜ
    const EDITOR_VERSION = '1.1.0'; // „Éê„Éº„Ç∏„Éß„É≥Áï™Âè∑
    
    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
    let layers = [
      {
        id: 0,
        name: "Base Layer",
        isBase: true,
        layerKey: null,
        mappings: []
      }
    ];
    let currentLayerId = 0;
    let nextLayerId = 1;
    let currentLayout = 'us'; // 'us' or 'jis'
    
    // ÈÅ∏ÊäûÁä∂ÊÖã
    let selectionMode = 'input';  // 'input' or 'output'
    let inputKeys = [];
    let inputModifiers = [];
    let outputKeys = [];
    let outputModifiers = [];

    // „Éï„É´„Ç≠„Éº„Éú„Éº„Éâ„É¨„Ç§„Ç¢„Ç¶„ÉàÂÆöÁæ©Ôºà„ÉÜ„É≥„Ç≠„Éº‰ªò„ÅçÔºâ
    const keyboardLayouts = {
      us: [
        // Row 1: Esc + Function keys + Print Screen, Scroll Lock, Pause
        [
          { code: 'Escape', label: 'Esc', x: 0, y: 0, w: 50, h: 50 },
          { code: 'F1', label: 'F1', x: 90, y: 0, w: 50, h: 50 },
          { code: 'F2', label: 'F2', x: 145, y: 0, w: 50, h: 50 },
          { code: 'F3', label: 'F3', x: 200, y: 0, w: 50, h: 50 },
          { code: 'F4', label: 'F4', x: 255, y: 0, w: 50, h: 50 },
          { code: 'F5', label: 'F5', x: 330, y: 0, w: 50, h: 50 },
          { code: 'F6', label: 'F6', x: 385, y: 0, w: 50, h: 50 },
          { code: 'F7', label: 'F7', x: 440, y: 0, w: 50, h: 50 },
          { code: 'F8', label: 'F8', x: 495, y: 0, w: 50, h: 50 },
          { code: 'F9', label: 'F9', x: 570, y: 0, w: 50, h: 50 },
          { code: 'F10', label: 'F10', x: 625, y: 0, w: 50, h: 50 },
          { code: 'F11', label: 'F11', x: 680, y: 0, w: 50, h: 50 },
          { code: 'F12', label: 'F12', x: 735, y: 0, w: 50, h: 50 },
          { code: 'PrintScreen', label: 'PrtSc', x: 810, y: 0, w: 50, h: 50 },
          { code: 'ScrollLock', label: 'ScrLk', x: 865, y: 0, w: 50, h: 50 },
          { code: 'Pause', label: 'Pause', x: 920, y: 0, w: 50, h: 50 },
        ],
        // Row 2: Number row
        [
          { code: 'Backquote', label: '`~', x: 0, y: 70, w: 50, h: 50 },
          { code: 'Digit1', label: '1!', x: 55, y: 70, w: 50, h: 50 },
          { code: 'Digit2', label: '2@', x: 110, y: 70, w: 50, h: 50 },
          { code: 'Digit3', label: '3#', x: 165, y: 70, w: 50, h: 50 },
          { code: 'Digit4', label: '4$', x: 220, y: 70, w: 50, h: 50 },
          { code: 'Digit5', label: '5%', x: 275, y: 70, w: 50, h: 50 },
          { code: 'Digit6', label: '6^', x: 330, y: 70, w: 50, h: 50 },
          { code: 'Digit7', label: '7&', x: 385, y: 70, w: 50, h: 50 },
          { code: 'Digit8', label: '8*', x: 440, y: 70, w: 50, h: 50 },
          { code: 'Digit9', label: '9(', x: 495, y: 70, w: 50, h: 50 },
          { code: 'Digit0', label: '0)', x: 550, y: 70, w: 50, h: 50 },
          { code: 'Minus', label: '-_', x: 605, y: 70, w: 50, h: 50 },
          { code: 'Equal', label: '=+', x: 660, y: 70, w: 50, h: 50 },
          { code: 'Backspace', label: 'Back', x: 715, y: 70, w: 70, h: 50 },
          { code: 'Insert', label: 'Ins', x: 810, y: 70, w: 50, h: 50 },
          { code: 'Home', label: 'Home', x: 865, y: 70, w: 50, h: 50 },
          { code: 'PageUp', label: 'PgUp', x: 920, y: 70, w: 50, h: 50 },
          { code: 'NumLock', label: 'NumLk', x: 995, y: 70, w: 50, h: 50 },
          { code: 'NumpadDivide', label: '/', x: 1050, y: 70, w: 50, h: 50 },
          { code: 'NumpadMultiply', label: '*', x: 1105, y: 70, w: 50, h: 50 },
          { code: 'NumpadSubtract', label: '-', x: 1160, y: 70, w: 50, h: 50 },
        ],
        // Row 3: Tab row
        [
          { code: 'Tab', label: 'Tab', x: 0, y: 125, w: 70, h: 50 },
          { code: 'KeyQ', label: 'Q', x: 75, y: 125, w: 50, h: 50 },
          { code: 'KeyW', label: 'W', x: 130, y: 125, w: 50, h: 50 },
          { code: 'KeyE', label: 'E', x: 185, y: 125, w: 50, h: 50 },
          { code: 'KeyR', label: 'R', x: 240, y: 125, w: 50, h: 50 },
          { code: 'KeyT', label: 'T', x: 295, y: 125, w: 50, h: 50 },
          { code: 'KeyY', label: 'Y', x: 350, y: 125, w: 50, h: 50 },
          { code: 'KeyU', label: 'U', x: 405, y: 125, w: 50, h: 50 },
          { code: 'KeyI', label: 'I', x: 460, y: 125, w: 50, h: 50 },
          { code: 'KeyO', label: 'O', x: 515, y: 125, w: 50, h: 50 },
          { code: 'KeyP', label: 'P', x: 570, y: 125, w: 50, h: 50 },
          { code: 'BracketLeft', label: '[{', x: 625, y: 125, w: 50, h: 50 },
          { code: 'BracketRight', label: ']}', x: 680, y: 125, w: 50, h: 50 },
          { code: 'Backslash', label: '\\|', x: 735, y: 125, w: 50, h: 50 },
          { code: 'Delete', label: 'Del', x: 810, y: 125, w: 50, h: 50 },
          { code: 'End', label: 'End', x: 865, y: 125, w: 50, h: 50 },
          { code: 'PageDown', label: 'PgDn', x: 920, y: 125, w: 50, h: 50 },
          { code: 'Numpad7', label: '7', x: 995, y: 125, w: 50, h: 50 },
          { code: 'Numpad8', label: '8', x: 1050, y: 125, w: 50, h: 50 },
          { code: 'Numpad9', label: '9', x: 1105, y: 125, w: 50, h: 50 },
          { code: 'NumpadAdd', label: '+', x: 1160, y: 125, w: 50, h: 105 },
        ],
        // Row 4: Caps Lock row
        [
          { code: 'CapsLock', label: 'Caps', x: 0, y: 180, w: 85, h: 50 },
          { code: 'KeyA', label: 'A', x: 90, y: 180, w: 50, h: 50 },
          { code: 'KeyS', label: 'S', x: 145, y: 180, w: 50, h: 50 },
          { code: 'KeyD', label: 'D', x: 200, y: 180, w: 50, h: 50 },
          { code: 'KeyF', label: 'F', x: 255, y: 180, w: 50, h: 50 },
          { code: 'KeyG', label: 'G', x: 310, y: 180, w: 50, h: 50 },
          { code: 'KeyH', label: 'H', x: 365, y: 180, w: 50, h: 50 },
          { code: 'KeyJ', label: 'J', x: 420, y: 180, w: 50, h: 50 },
          { code: 'KeyK', label: 'K', x: 475, y: 180, w: 50, h: 50 },
          { code: 'KeyL', label: 'L', x: 530, y: 180, w: 50, h: 50 },
          { code: 'Semicolon', label: ';:', x: 585, y: 180, w: 50, h: 50 },
          { code: 'Quote', label: '\'"', x: 640, y: 180, w: 50, h: 50 },
          { code: 'Enter', label: 'Enter', x: 695, y: 180, w: 90, h: 50 },
          { code: 'Numpad4', label: '4', x: 995, y: 180, w: 50, h: 50 },
          { code: 'Numpad5', label: '5', x: 1050, y: 180, w: 50, h: 50 },
          { code: 'Numpad6', label: '6', x: 1105, y: 180, w: 50, h: 50 },
        ],
        // Row 5: Shift row
        [
          { code: 'ShiftLeft', label: 'Shift', x: 0, y: 235, w: 110, h: 50 },
          { code: 'KeyZ', label: 'Z', x: 115, y: 235, w: 50, h: 50 },
          { code: 'KeyX', label: 'X', x: 170, y: 235, w: 50, h: 50 },
          { code: 'KeyC', label: 'C', x: 225, y: 235, w: 50, h: 50 },
          { code: 'KeyV', label: 'V', x: 280, y: 235, w: 50, h: 50 },
          { code: 'KeyB', label: 'B', x: 335, y: 235, w: 50, h: 50 },
          { code: 'KeyN', label: 'N', x: 390, y: 235, w: 50, h: 50 },
          { code: 'KeyM', label: 'M', x: 445, y: 235, w: 50, h: 50 },
          { code: 'Comma', label: ',<', x: 500, y: 235, w: 50, h: 50 },
          { code: 'Period', label: '.>', x: 555, y: 235, w: 50, h: 50 },
          { code: 'Slash', label: '/?', x: 610, y: 235, w: 50, h: 50 },
          { code: 'ShiftRight', label: 'Shift', x: 665, y: 235, w: 120, h: 50 },
          { code: 'ArrowUp', label: '‚Üë', x: 865, y: 235, w: 50, h: 50 },
          { code: 'Numpad1', label: '1', x: 995, y: 235, w: 50, h: 50 },
          { code: 'Numpad2', label: '2', x: 1050, y: 235, w: 50, h: 50 },
          { code: 'Numpad3', label: '3', x: 1105, y: 235, w: 50, h: 50 },
          { code: 'NumpadEnter', label: 'Enter', x: 1160, y: 235, w: 50, h: 105 },
        ],
        // Row 6: Control row
        [
          { code: 'ControlLeft', label: 'Ctrl', x: 0, y: 290, w: 65, h: 50 },
          { code: 'MetaLeft', label: 'Win', x: 70, y: 290, w: 65, h: 50 },
          { code: 'AltLeft', label: 'Alt', x: 140, y: 290, w: 65, h: 50 },
          { code: 'Space', label: 'Space', x: 210, y: 290, w: 270, h: 50 },
          { code: 'AltRight', label: 'Alt', x: 485, y: 290, w: 65, h: 50 },
          { code: 'MetaRight', label: 'Win', x: 555, y: 290, w: 65, h: 50 },
          { code: 'ContextMenu', label: 'Menu', x: 625, y: 290, w: 65, h: 50 },
          { code: 'ControlRight', label: 'Ctrl', x: 695, y: 290, w: 90, h: 50 },
          { code: 'ArrowLeft', label: '‚Üê', x: 810, y: 290, w: 50, h: 50 },
          { code: 'ArrowDown', label: '‚Üì', x: 865, y: 290, w: 50, h: 50 },
          { code: 'ArrowRight', label: '‚Üí', x: 920, y: 290, w: 50, h: 50 },
          { code: 'Numpad0', label: '0', x: 995, y: 290, w: 105, h: 50 },
          { code: 'NumpadDecimal', label: '.', x: 1105, y: 290, w: 50, h: 50 },
        ],
      ],
      jis: [
        // Row 1: Esc + Function keys + Print Screen, Scroll Lock, Pause
        [
          { code: 'Escape', label: 'Esc', x: 0, y: 0, w: 50, h: 50 },
          { code: 'F1', label: 'F1', x: 90, y: 0, w: 50, h: 50 },
          { code: 'F2', label: 'F2', x: 145, y: 0, w: 50, h: 50 },
          { code: 'F3', label: 'F3', x: 200, y: 0, w: 50, h: 50 },
          { code: 'F4', label: 'F4', x: 255, y: 0, w: 50, h: 50 },
          { code: 'F5', label: 'F5', x: 330, y: 0, w: 50, h: 50 },
          { code: 'F6', label: 'F6', x: 385, y: 0, w: 50, h: 50 },
          { code: 'F7', label: 'F7', x: 440, y: 0, w: 50, h: 50 },
          { code: 'F8', label: 'F8', x: 495, y: 0, w: 50, h: 50 },
          { code: 'F9', label: 'F9', x: 570, y: 0, w: 50, h: 50 },
          { code: 'F10', label: 'F10', x: 625, y: 0, w: 50, h: 50 },
          { code: 'F11', label: 'F11', x: 680, y: 0, w: 50, h: 50 },
          { code: 'F12', label: 'F12', x: 735, y: 0, w: 50, h: 50 },
          { code: 'PrintScreen', label: 'PrtSc', x: 810, y: 0, w: 50, h: 50 },
          { code: 'ScrollLock', label: 'ScrLk', x: 865, y: 0, w: 50, h: 50 },
          { code: 'Pause', label: 'Pause', x: 920, y: 0, w: 50, h: 50 },
        ],
        // Row 2: Number row (JIS)
        [
          { code: 'Zenkaku', label: 'Âçä/ÂÖ®', x: 0, y: 70, w: 50, h: 50 },
          { code: 'Digit1', label: '1!', x: 55, y: 70, w: 50, h: 50 },
          { code: 'Digit2', label: '2"', x: 110, y: 70, w: 50, h: 50 },
          { code: 'Digit3', label: '3#', x: 165, y: 70, w: 50, h: 50 },
          { code: 'Digit4', label: '4$', x: 220, y: 70, w: 50, h: 50 },
          { code: 'Digit5', label: '5%', x: 275, y: 70, w: 50, h: 50 },
          { code: 'Digit6', label: '6&', x: 330, y: 70, w: 50, h: 50 },
          { code: 'Digit7', label: '7\'', x: 385, y: 70, w: 50, h: 50 },
          { code: 'Digit8', label: '8(', x: 440, y: 70, w: 50, h: 50 },
          { code: 'Digit9', label: '9)', x: 495, y: 70, w: 50, h: 50 },
          { code: 'Digit0', label: '0', x: 550, y: 70, w: 50, h: 50 },
          { code: 'Minus', label: '-=', x: 605, y: 70, w: 50, h: 50 },
          { code: 'Equal', label: '^~', x: 660, y: 70, w: 50, h: 50 },
          { code: 'IntlYen', label: '¬•|', x: 715, y: 70, w: 50, h: 50 },
          { code: 'Backspace', label: 'BS', x: 770, y: 70, w: 65, h: 50 },
          { code: 'Insert', label: 'Ins', x: 860, y: 70, w: 50, h: 50 },
          { code: 'Home', label: 'Home', x: 915, y: 70, w: 50, h: 50 },
          { code: 'PageUp', label: 'PgUp', x: 970, y: 70, w: 50, h: 50 },
          { code: 'NumLock', label: 'NumLk', x: 1045, y: 70, w: 50, h: 50 },
          { code: 'NumpadDivide', label: '/', x: 1100, y: 70, w: 50, h: 50 },
          { code: 'NumpadMultiply', label: '*', x: 1155, y: 70, w: 50, h: 50 },
          { code: 'NumpadSubtract', label: '-', x: 1210, y: 70, w: 50, h: 50 },
        ],
        // Row 3: Tab row (JIS)
        [
          { code: 'Tab', label: 'Tab', x: 0, y: 125, w: 70, h: 50 },
          { code: 'KeyQ', label: 'Q', x: 75, y: 125, w: 50, h: 50 },
          { code: 'KeyW', label: 'W', x: 130, y: 125, w: 50, h: 50 },
          { code: 'KeyE', label: 'E', x: 185, y: 125, w: 50, h: 50 },
          { code: 'KeyR', label: 'R', x: 240, y: 125, w: 50, h: 50 },
          { code: 'KeyT', label: 'T', x: 295, y: 125, w: 50, h: 50 },
          { code: 'KeyY', label: 'Y', x: 350, y: 125, w: 50, h: 50 },
          { code: 'KeyU', label: 'U', x: 405, y: 125, w: 50, h: 50 },
          { code: 'KeyI', label: 'I', x: 460, y: 125, w: 50, h: 50 },
          { code: 'KeyO', label: 'O', x: 515, y: 125, w: 50, h: 50 },
          { code: 'KeyP', label: 'P', x: 570, y: 125, w: 50, h: 50 },
          { code: 'BracketLeft', label: '@`', x: 625, y: 125, w: 50, h: 50 },
          { code: 'BracketRight', label: '[{', x: 680, y: 125, w: 50, h: 50 },
          { code: 'Delete', label: 'Del', x: 860, y: 125, w: 50, h: 50 },
          { code: 'End', label: 'End', x: 915, y: 125, w: 50, h: 50 },
          { code: 'PageDown', label: 'PgDn', x: 970, y: 125, w: 50, h: 50 },
          { code: 'Numpad7', label: '7', x: 1045, y: 125, w: 50, h: 50 },
          { code: 'Numpad8', label: '8', x: 1100, y: 125, w: 50, h: 50 },
          { code: 'Numpad9', label: '9', x: 1155, y: 125, w: 50, h: 50 },
          { code: 'NumpadAdd', label: '+', x: 1210, y: 125, w: 50, h: 105 },
        ],
        // Row 4: Caps Lock row (JIS)
        [
          { code: 'CapsLock', label: 'Ëã±Êï∞', x: 0, y: 180, w: 85, h: 50 },
          { code: 'KeyA', label: 'A', x: 90, y: 180, w: 50, h: 50 },
          { code: 'KeyS', label: 'S', x: 145, y: 180, w: 50, h: 50 },
          { code: 'KeyD', label: 'D', x: 200, y: 180, w: 50, h: 50 },
          { code: 'KeyF', label: 'F', x: 255, y: 180, w: 50, h: 50 },
          { code: 'KeyG', label: 'G', x: 310, y: 180, w: 50, h: 50 },
          { code: 'KeyH', label: 'H', x: 365, y: 180, w: 50, h: 50 },
          { code: 'KeyJ', label: 'J', x: 420, y: 180, w: 50, h: 50 },
          { code: 'KeyK', label: 'K', x: 475, y: 180, w: 50, h: 50 },
          { code: 'KeyL', label: 'L', x: 530, y: 180, w: 50, h: 50 },
          { code: 'Semicolon', label: ';+', x: 585, y: 180, w: 50, h: 50 },
          { code: 'Quote', label: ':*', x: 640, y: 180, w: 50, h: 50 },
          { code: 'Backslash', label: ']}', x: 695, y: 180, w: 50, h: 50 },
          { code: 'Enter', label: 'Enter', x: 750, y: 180, w: 85, h: 50 },
          { code: 'Numpad4', label: '4', x: 1045, y: 180, w: 50, h: 50 },
          { code: 'Numpad5', label: '5', x: 1100, y: 180, w: 50, h: 50 },
          { code: 'Numpad6', label: '6', x: 1155, y: 180, w: 50, h: 50 },
        ],
        // Row 5: Shift row (JIS)
        [
          { code: 'ShiftLeft', label: 'Shift', x: 0, y: 235, w: 110, h: 50 },
          { code: 'KeyZ', label: 'Z', x: 115, y: 235, w: 50, h: 50 },
          { code: 'KeyX', label: 'X', x: 170, y: 235, w: 50, h: 50 },
          { code: 'KeyC', label: 'C', x: 225, y: 235, w: 50, h: 50 },
          { code: 'KeyV', label: 'V', x: 280, y: 235, w: 50, h: 50 },
          { code: 'KeyB', label: 'B', x: 335, y: 235, w: 50, h: 50 },
          { code: 'KeyN', label: 'N', x: 390, y: 235, w: 50, h: 50 },
          { code: 'KeyM', label: 'M', x: 445, y: 235, w: 50, h: 50 },
          { code: 'Comma', label: ',<', x: 500, y: 235, w: 50, h: 50 },
          { code: 'Period', label: '.>', x: 555, y: 235, w: 50, h: 50 },
          { code: 'Slash', label: '/?', x: 610, y: 235, w: 50, h: 50 },
          { code: 'IntlRo', label: '\\_', x: 665, y: 235, w: 50, h: 50 },
          { code: 'ShiftRight', label: 'Shift', x: 720, y: 235, w: 115, h: 50 },
          { code: 'ArrowUp', label: '‚Üë', x: 915, y: 235, w: 50, h: 50 },
          { code: 'Numpad1', label: '1', x: 1045, y: 235, w: 50, h: 50 },
          { code: 'Numpad2', label: '2', x: 1100, y: 235, w: 50, h: 50 },
          { code: 'Numpad3', label: '3', x: 1155, y: 235, w: 50, h: 50 },
          { code: 'NumpadEnter', label: 'Enter', x: 1210, y: 235, w: 50, h: 105 },
        ],
        // Row 6: Control row (JIS)
        [
          { code: 'ControlLeft', label: 'Ctrl', x: 0, y: 290, w: 65, h: 50 },
          { code: 'MetaLeft', label: 'Win', x: 70, y: 290, w: 50, h: 50 },
          { code: 'AltLeft', label: 'Alt', x: 125, y: 290, w: 50, h: 50 },
          { code: 'NonConvert', label: 'ÁÑ°Â§âÊèõ', x: 180, y: 290, w: 60, h: 50 },
          { code: 'Space', label: 'Space', x: 245, y: 290, w: 175, h: 50 },
          { code: 'Convert', label: 'Â§âÊèõ', x: 425, y: 290, w: 60, h: 50 },
          { code: 'KanaMode', label: '„Ç´„Éä', x: 490, y: 290, w: 60, h: 50 },
          { code: 'AltRight', label: 'Alt', x: 555, y: 290, w: 50, h: 50 },
          { code: 'MetaRight', label: 'Win', x: 610, y: 290, w: 50, h: 50 },
          { code: 'ContextMenu', label: 'Menu', x: 665, y: 290, w: 55, h: 50 },
          { code: 'ControlRight', label: 'Ctrl', x: 725, y: 290, w: 110, h: 50 },
          { code: 'ArrowLeft', label: '‚Üê', x: 860, y: 290, w: 50, h: 50 },
          { code: 'ArrowDown', label: '‚Üì', x: 915, y: 290, w: 50, h: 50 },
          { code: 'ArrowRight', label: '‚Üí', x: 970, y: 290, w: 50, h: 50 },
          { code: 'Numpad0', label: '0', x: 1045, y: 290, w: 105, h: 50 },
          { code: 'NumpadDecimal', label: '.', x: 1155, y: 290, w: 50, h: 50 },
        ],
      ]
    };

    let keyboardLayout = keyboardLayouts.us;
    // AHK„Ç≠„Éº„Éû„ÉÉ„Éó
    const ahkKeyMap = {
      'Escape': 'Esc', 'Digit1': '1', 'Digit2': '2', 'Digit3': '3', 'Digit4': '4',
      'Digit5': '5', 'Digit6': '6', 'Digit7': '7', 'Digit8': '8', 'Digit9': '9', 'Digit0': '0',
      'Minus': '-', 'Equal': '=', 'Backspace': 'Backspace', 'Tab': 'Tab',
      'KeyQ': 'q', 'KeyW': 'w', 'KeyE': 'e', 'KeyR': 'r', 'KeyT': 't',
      'KeyY': 'y', 'KeyU': 'u', 'KeyI': 'i', 'KeyO': 'o', 'KeyP': 'p',
      'BracketLeft': '[', 'BracketRight': ']', 'Backslash': '\\',
      'CapsLock': 'CapsLock', 'KeyA': 'a', 'KeyS': 's', 'KeyD': 'd', 'KeyF': 'f',
      'KeyG': 'g', 'KeyH': 'h', 'KeyJ': 'j', 'KeyK': 'k', 'KeyL': 'l',
      'Semicolon': 'sc027', 'Quote': '\'', 'Enter': 'Enter',
      'ShiftLeft': 'LShift', 'KeyZ': 'z', 'KeyX': 'x', 'KeyC': 'c', 'KeyV': 'v',
      'KeyB': 'b', 'KeyN': 'n', 'KeyM': 'm', 'Comma': ',', 'Period': '.', 'Slash': '/',
      'ShiftRight': 'RShift', 'ControlLeft': 'LControl', 'MetaLeft': 'LWin',
      'AltLeft': 'LAlt', 'Space': 'Space', 'AltRight': 'RAlt', 'MetaRight': 'RWin',
      'ContextMenu': 'AppsKey', 'ControlRight': 'RControl',
      'PrintScreen': 'PrintScreen', 'ScrollLock': 'ScrollLock', 'Pause': 'Pause',
      'Insert': 'Insert', 'Delete': 'Delete', 'Home': 'Home', 'End': 'End',
      'PageUp': 'PgUp', 'PageDown': 'PgDn',
      'ArrowLeft': 'Left', 'ArrowUp': 'Up', 'ArrowRight': 'Right', 'ArrowDown': 'Down',
      'NumLock': 'NumLock', 'NumpadDivide': 'NumpadDiv', 'NumpadMultiply': 'NumpadMult',
      'NumpadSubtract': 'NumpadSub', 'NumpadAdd': 'NumpadAdd', 'NumpadEnter': 'NumpadEnter',
      'Numpad0': 'Numpad0', 'Numpad1': 'Numpad1', 'Numpad2': 'Numpad2', 'Numpad3': 'Numpad3',
      'Numpad4': 'Numpad4', 'Numpad5': 'Numpad5', 'Numpad6': 'Numpad6', 'Numpad7': 'Numpad7',
      'Numpad8': 'Numpad8', 'Numpad9': 'Numpad9', 'NumpadDecimal': 'NumpadDot',
      'F1': 'F1', 'F2': 'F2', 'F3': 'F3', 'F4': 'F4', 'F5': 'F5', 'F6': 'F6',
      'F7': 'F7', 'F8': 'F8', 'F9': 'F9', 'F10': 'F10', 'F11': 'F11', 'F12': 'F12',
      'Backquote': '`',
      // Êó•Êú¨Ë™ûÈÖçÂàóÂ∞ÇÁî®„Ç≠„Éº
      'Zenkaku': 'vk1Dsc07B',  // ÂçäËßí/ÂÖ®Ëßí
      'IntlYen': 'vk5Csc07D',   // ¬•„Ç≠„Éº
      'IntlRo': 'vkE2sc073',    // „Çç„Ç≠„ÉºÔºà_„Ç≠„ÉºÔºâ
      'NonConvert': 'sc07B',    // ÁÑ°Â§âÊèõÔºàSC„Ç≥„Éº„Éâ‰ΩøÁî®„ÅßÂÆöÁæ©‰∏çË¶ÅÔºâ
      'Convert': 'sc079',       // Â§âÊèõÔºàSC„Ç≥„Éº„Éâ‰ΩøÁî®„ÅßÂÆöÁæ©‰∏çË¶ÅÔºâ
      'KanaMode': 'vkF2sc070',   // „Ç´„Éä/„É≠„Éº„ÉûÂ≠ó
      // ÁâπÊÆä„Ç¢„ÇØ„Ç∑„Éß„É≥
      'Disable': 'return',
      'LButton': 'LButton',
      'RButton': 'RButton',
      'MButton': 'MButton',
      'XButton1': 'XButton1',
      'XButton2': 'XButton2',
      'WheelUp': 'WheelUp',
      'WheelDown': 'WheelDown',
      'WheelLeft': 'WheelLeft',
      'WheelRight': 'WheelRight',
      // „É°„Éá„Ç£„Ç¢„Ç≠„Éº
      'Media_Play_Pause': 'Media_Play_Pause',
      'Media_Stop': 'Media_Stop',
      'Media_Prev': 'Media_Prev',
      'Media_Next': 'Media_Next',
      'Volume_Up': 'Volume_Up',
      'Volume_Down': 'Volume_Down',
      'Volume_Mute': 'Volume_Mute',
      // „Éñ„É©„Ç¶„Ç∂„Ç≠„Éº
      'Browser_Back': 'Browser_Back',
      'Browser_Forward': 'Browser_Forward',
      'Browser_Refresh': 'Browser_Refresh',
      'Browser_Home': 'Browser_Home'
    };

    // ÁâπÊÆä„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅÆ„É©„Éô„É´
    const specialActionLabels = {
      'LButton': 'üñ±Ô∏èÂ∑¶„ÇØ„É™„ÉÉ„ÇØ',
      'RButton': 'üñ±Ô∏èÂè≥„ÇØ„É™„ÉÉ„ÇØ',
      'MButton': 'üñ±Ô∏è‰∏≠„ÇØ„É™„ÉÉ„ÇØ',
      'XButton1': 'üñ±Ô∏èÊàª„Çã',
      'XButton2': 'üñ±Ô∏èÈÄ≤„ÇÄ',
      'WheelUp': 'üñ±Ô∏è‚Üë',
      'WheelDown': 'üñ±Ô∏è‚Üì',
      'WheelLeft': 'üñ±Ô∏è‚Üê',
      'WheelRight': 'üñ±Ô∏è‚Üí',
      'Media_Play_Pause': '‚èØÔ∏è',
      'Media_Stop': '‚èπÔ∏è',
      'Media_Prev': '‚èÆÔ∏è',
      'Media_Next': '‚è≠Ô∏è',
      'Volume_Up': 'üîä',
      'Volume_Down': 'üîâ',
      'Volume_Mute': 'üîá',
      'Browser_Back': '‚óÄÔ∏è',
      'Browser_Forward': '‚ñ∂Ô∏è',
      'Browser_Refresh': 'üîÑ',
      'Browser_Home': 'üè†',
      'Disable': 'üö´ÁÑ°Âäπ'
    };

    // ÂàùÊúüÂåñ
    function init() {
      initModal();
      adjustBodyPadding();
      renderLayerTabs();
      renderLayerSettings();
      renderKeyboard();
      updateSelectedKeysDisplay();
      populateLayerKeySelect();
      
      // ÂàùÊúü„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíË®≠ÂÆö
      const ahkOutput = document.getElementById('ahkOutput');
      if (ahkOutput) {
        ahkOutput.textContent = translations[currentLang].scriptPlaceholder;
      }
      
      // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫ÊôÇ„Å´„ÇÇË™øÊï¥
      window.addEventListener('resize', adjustBodyPadding);
    }

    // Âõ∫ÂÆö„Éò„ÉÉ„ÉÄ„Éº„ÅÆÈ´ò„Åï„Å´Âøú„Åò„Å¶body„ÅÆpadding-top„ÇíË™øÊï¥
    function adjustBodyPadding() {
      const header = document.querySelector('.fixed-header');
      if (header) {
        const headerHeight = header.offsetHeight;
        document.body.style.paddingTop = (headerHeight + 20) + 'px';
      }
    }

    // „É¨„Ç§„É§„Éº„Çø„ÉñÊèèÁîª
    function renderLayerTabs() {
      const tabsContainer = document.getElementById('layerTabs');
      tabsContainer.innerHTML = '';

      layers.forEach(layer => {
        const tab = document.createElement('div');
        tab.className = 'layer-tab' + (layer.id === currentLayerId ? ' active' : '');
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = layer.name;
        tab.appendChild(nameSpan);

        if (layer.layerKey) {
          const badge = document.createElement('span');
          badge.className = 'layer-key-badge';
          badge.textContent = getKeyLabel(layer.layerKey);
          tab.appendChild(badge);
        }

        if (!layer.isBase) {
          const deleteBtn = document.createElement('span');
          deleteBtn.className = 'delete-layer';
          deleteBtn.textContent = '√ó';
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteLayer(layer.id);
          };
          tab.appendChild(deleteBtn);
        }

        tab.onclick = () => switchLayer(layer.id);
        tabsContainer.appendChild(tab);
      });

      // Êñ∞Ë¶è„É¨„Ç§„É§„ÉºËøΩÂä†„Éú„Çø„É≥
      const addBtn = document.createElement('button');
      addBtn.className = 'add-layer-btn';
      addBtn.id = 'addLayerBtn';
      addBtn.textContent = translations[currentLang].addLayerBtn || '+ Êñ∞Ë¶è„É¨„Ç§„É§„Éº';
      addBtn.onclick = addLayer;
      tabsContainer.appendChild(addBtn);
    }

    // „É¨„Ç§„É§„ÉºË®≠ÂÆö„Éë„Éç„É´ÊèèÁîª
    function renderLayerSettings() {
      const layer = layers.find(l => l.id === currentLayerId);
      if (!layer) return;

      // „É¨„Ç§„É§„ÉºÈÅ∏Êäû„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÊõ¥Êñ∞
      const layerSelect = document.getElementById('layerSelect');
      if (layerSelect) {
        layerSelect.innerHTML = '';
        layers.forEach(l => {
          const option = document.createElement('option');
          option.value = l.id;
          option.textContent = l.name;
          option.selected = l.id === currentLayerId;
          layerSelect.appendChild(option);
        });
      }

      document.getElementById('layerName').value = layer.name;
      document.getElementById('layerName').onchange = (e) => {
        layer.name = e.target.value;
        // „É¨„Ç§„É§„ÉºÈÅ∏Êäû„ÇÇÊõ¥Êñ∞
        const layerSelect = document.getElementById('layerSelect');
        if (layerSelect) {
          const option = layerSelect.querySelector(`option[value="${layer.id}"]`);
          if (option) option.textContent = e.target.value;
        }
      };

      const layerKeyRow = document.getElementById('layerKeyRow');
      const layerKeySelect = document.getElementById('layerKeySelect');
      
      if (layer.isBase) {
        layerKeyRow.style.display = 'none';
      } else {
        layerKeyRow.style.display = 'block';
        
        // „É¨„Ç§„É§„Éº„Ç≠„ÉºÈÅ∏ÊäûËÇ¢„ÇíÁîüÊàêÔºà‰ΩøÁî®‰∏≠„ÅÆ„Ç≠„Éº„ÇíÁÑ°ÂäπÂåñÔºâ
        populateLayerKeySelect();
        
        layerKeySelect.value = layer.layerKey || '';
        layerKeySelect.onchange = (e) => {
          const newLayerKey = e.target.value || null;
          const oldLayerKey = layer.layerKey;
          
          // „É¨„Ç§„É§„Éº„Ç≠„Éº„ÅÆÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
          if (newLayerKey) {
            const duplicateLayer = layers.find(l => 
              !l.isBase && l.id !== layer.id && l.layerKey === newLayerKey
            );
            
            if (duplicateLayer) {
              alert(`„É¨„Ç§„É§„Éº„Ç≠„Éº„Äå${getKeyLabel(newLayerKey)}„Äç„ÅØÊó¢„Å´„Äå${duplicateLayer.name}„Äç„Åß‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ\nÂà•„ÅÆ„Ç≠„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
              // ÈÅ∏Êäû„ÇíÂÖÉ„Å´Êàª„Åô
              layerKeySelect.value = oldLayerKey || '';
              return;
            }
          }
          
          layer.layerKey = newLayerKey;
          
          // Base Layer„ÇíÂèñÂæó
          const baseLayer = layers.find(l => l.isBase);
          if (!baseLayer) return;
          
          // Êñ∞„Åó„ÅÑ„É¨„Ç§„É§„Éº„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„ÅüÂ†¥Âêà„ÄÅBase Layer„Å´ÁÑ°ÂäπÂåñ„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíËøΩÂä†
          if (newLayerKey) {
            // Base LayerÂÜÖ„ÅÆÊó¢Â≠ò„ÅÆÁÑ°ÂäπÂåñ„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÊé¢„Åô
            const existingDisableIndex = baseLayer.mappings.findIndex(m => 
              m.input.length === 1 && 
              m.input[0] === newLayerKey && 
              m.output.length === 1 && 
              m.output[0] === 'Disable'
            );
            
            // „Åæ„Å†ÁÑ°ÂäπÂåñ„Éû„ÉÉ„Éî„É≥„Ç∞„Åå„Å™„Åë„Çå„Å∞Base Layer„Å´ËøΩÂä†
            if (existingDisableIndex === -1) {
              baseLayer.mappings.push({
                input: [newLayerKey],
                output: ['Disable'],
                outputModifiers: []
              });
            }
          }
          
          // Âè§„ÅÑ„É¨„Ç§„É§„Éº„Ç≠„Éº„ÅÆÁÑ°ÂäπÂåñ„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíBase Layer„Åã„ÇâÂâäÈô§
          if (oldLayerKey && oldLayerKey !== newLayerKey) {
            // ‰ªñ„ÅÆ„É¨„Ç§„É§„Éº„ÅßÂêå„Åò„Ç≠„Éº„Åå„É¨„Ç§„É§„Éº„Ç≠„Éº„Å®„Åó„Å¶‰Ωø„Çè„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÅãÁ¢∫Ë™ç
            const otherLayersUsingOldKey = layers.some(l => 
              !l.isBase && l.id !== layer.id && l.layerKey === oldLayerKey
            );
            
            // ‰ªñ„ÅÆ„É¨„Ç§„É§„Éº„Åß‰Ωø„Çè„Çå„Å¶„ÅÑ„Å™„Åë„Çå„Å∞ÂâäÈô§
            if (!otherLayersUsingOldKey) {
              const oldDisableIndex = baseLayer.mappings.findIndex(m =>
                m.input.length === 1 &&
                m.input[0] === oldLayerKey &&
                m.output.length === 1 &&
                m.output[0] === 'Disable'
              );
              if (oldDisableIndex !== -1) {
                baseLayer.mappings.splice(oldDisableIndex, 1);
              }
            }
          }
          
          // ÁèæÂú®„ÅÆ„É¨„Ç§„É§„Éº„Å®„ÄÅBase Layer„ÅÆ‰∏°Êñπ„ÇíÊõ¥Êñ∞
          updateMappingList();
          generateAHK();
          renderLayerTabs();
          renderKeyboard();
          
          // „É¨„Ç§„É§„Éº„Ç≠„ÉºÈÅ∏ÊäûËÇ¢„ÇíÂÜçÁîüÊàêÔºà‰ΩøÁî®‰∏≠Ë°®Á§∫„ÇíÊõ¥Êñ∞Ôºâ
          populateLayerKeySelect();
          
          // ÁèæÂú®„ÅÆÂÄ§„ÇíÂÜçË®≠ÂÆö
          layerKeySelect.value = newLayerKey || '';
        };
      }
    }

    // „É¨„Ç§„É§„Éº„Ç≠„ÉºÈÅ∏ÊäûËÇ¢„ÅÆÁîüÊàê
    function populateLayerKeySelect() {
      const select = document.getElementById('layerKeySelect');
      const currentLayer = layers.find(l => l.id === currentLayerId);
      select.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
      
      // ÂÖ®„Ç≠„Éº„ÇíÈÅ∏ÊäûËÇ¢„Å´ËøΩÂä†
      const allKeys = [];
      keyboardLayout.forEach(row => {
        row.forEach(key => {
          allKeys.push({ code: key.code, label: key.label });
        });
      });

      // ‰ΩøÁî®‰∏≠„ÅÆ„É¨„Ç§„É§„Éº„Ç≠„Éº„ÇíÂèñÂæó
      const usedLayerKeys = new Set();
      layers.forEach(layer => {
        if (!layer.isBase && layer.layerKey && layer.id !== currentLayerId) {
          usedLayerKeys.add(layer.layerKey);
        }
      });

      allKeys.sort((a, b) => a.label.localeCompare(b.label));
      allKeys.forEach(key => {
        const option = document.createElement('option');
        option.value = key.code;
        
        // ‰ΩøÁî®‰∏≠„ÅÆ„Ç≠„Éº„ÅØÁÑ°ÂäπÂåñ„Åó„Å¶Ë°®Á§∫
        if (usedLayerKeys.has(key.code)) {
          option.textContent = `${key.label} (‰ΩøÁî®‰∏≠)`;
          option.disabled = true;
          option.style.color = '#999';
        } else {
          option.textContent = key.label;
        }
        
        select.appendChild(option);
      });
    }

    // „É¨„Ç§„É§„ÉºËøΩÂä†
    function addLayer() {
      const newLayer = {
        id: nextLayerId++,
        name: `Layer ${nextLayerId - 1}`,
        isBase: false,
        layerKey: null,
        mappings: []
      };
      layers.push(newLayer);
      currentLayerId = newLayer.id;
      renderLayerTabs();
      renderLayerSettings();
      renderKeyboard();
      clearSelection();
    }

    // „É¨„Ç§„É§„ÉºÂâäÈô§
    function deleteLayer(layerId) {
      if (layers.length <= 1) {
        alert('ÊúÄÂæå„ÅÆ„É¨„Ç§„É§„Éº„ÅØÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì');
        return;
      }
      
      if (!confirm('„Åì„ÅÆ„É¨„Ç§„É§„Éº„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

      // ÂâäÈô§„Åô„Çã„É¨„Ç§„É§„Éº„ÅÆ„É¨„Ç§„É§„Éº„Ç≠„Éº„ÇíÂèñÂæó
      const deletingLayer = layers.find(l => l.id === layerId);
      const deletingLayerKey = deletingLayer ? deletingLayer.layerKey : null;

      layers = layers.filter(l => l.id !== layerId);
      
      // ÂâäÈô§„Åó„Åü„É¨„Ç§„É§„Éº„ÅÆ„É¨„Ç§„É§„Éº„Ç≠„Éº„Åå„ÄÅ‰ªñ„ÅÆ„É¨„Ç§„É§„Éº„Åß‰Ωø„Çè„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÅãÁ¢∫Ë™ç
      if (deletingLayerKey) {
        const otherLayersUsingKey = layers.some(l => 
          !l.isBase && l.layerKey === deletingLayerKey
        );
        
        // ‰ªñ„ÅÆ„É¨„Ç§„É§„Éº„Åß‰Ωø„Çè„Çå„Å¶„ÅÑ„Å™„Åë„Çå„Å∞„ÄÅBase Layer„Åã„ÇâÁÑ°ÂäπÂåñ„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÂâäÈô§
        if (!otherLayersUsingKey) {
          const baseLayer = layers.find(l => l.isBase);
          if (baseLayer) {
            const disableIndex = baseLayer.mappings.findIndex(m =>
              m.input.length === 1 &&
              m.input[0] === deletingLayerKey &&
              m.output.length === 1 &&
              m.output[0] === 'Disable'
            );
            if (disableIndex !== -1) {
              baseLayer.mappings.splice(disableIndex, 1);
            }
          }
        }
      }
      
      if (currentLayerId === layerId) {
        currentLayerId = layers[0].id;
      }
      renderLayerTabs();
      renderLayerSettings();
      renderKeyboard();
      updateMappingList();
      generateAHK();
    }

    // „É¨„Ç§„É§„ÉºÂàá„ÇäÊõø„Åà
    function switchLayer(layerId) {
      currentLayerId = layerId;
      renderLayerTabs();
      renderLayerSettings();
      renderKeyboard();
      clearSelection();
      updateMappingList();
    }

    // Êñ∞„Åó„ÅÑ„É¨„Ç§„É§„Éº„ÇíËøΩÂä†
    function addNewLayer() {
      const newLayerId = Date.now().toString();
      const newLayerNumber = layers.length + 1;
      const newLayer = {
        id: newLayerId,
        name: `Layer${newLayerNumber}`,
        isBase: false,
        layerKey: null,
        mappings: []
      };
      
      layers.push(newLayer);
      currentLayerId = newLayerId;
      renderLayerSettings();
      renderKeyboard();
      clearSelection();
      updateMappingList();
      generateScript();
    }

    // „Ç≠„Éº„Éú„Éº„ÉâÊèèÁîª
    function renderKeyboard() {
      const keyboard = document.getElementById('keyboard');
      keyboard.innerHTML = '';

      const layer = layers.find(l => l.id === currentLayerId);
      if (!layer) return;

      keyboardLayout.forEach(row => {
        row.forEach(keyInfo => {
          const keyEl = document.createElement('div');
          keyEl.className = 'key';
          keyEl.style.left = keyInfo.x + 'px';
          keyEl.style.top = keyInfo.y + 'px';
          keyEl.style.width = keyInfo.w + 'px';
          keyEl.style.height = keyInfo.h + 'px';

          const mainLabel = document.createElement('div');
          mainLabel.className = 'key-main-label';
          mainLabel.textContent = keyInfo.label;
          keyEl.appendChild(mainLabel);

          // „Éû„ÉÉ„Éî„É≥„Ç∞ÊÉÖÂ†±Ë°®Á§∫
          const mapping = layer.mappings.find(m => 
            m.input.includes(keyInfo.code)
          );
          if (mapping) {
            keyEl.classList.add('mapped');
            const subLabel = document.createElement('div');
            subLabel.className = 'key-sub-label';
            
            // ‰øÆÈ£æ„Ç≠„Éº„ÇíÂê´„ÇÅ„ÅüÂá∫ÂäõÊñáÂ≠óÂàó„ÇíÁîüÊàê
            let outputStr = '';
            if (mapping.outputModifiers && mapping.outputModifiers.length > 0) {
              outputStr = mapping.outputModifiers.map(m => {
                const mod = modifierKeys.find(mk => mk.code === m);
                return mod ? mod.label : m;
              }).join('+');
              if (mapping.output.length > 0) {
                outputStr += '+';
              }
            }
            outputStr += mapping.output.map(k => getKeyLabel(k)).join('+');
            
            subLabel.textContent = '‚Üí' + outputStr;
            keyEl.appendChild(subLabel);
          }

          // „É¨„Ç§„É§„Éº„Ç≠„ÉºË°®Á§∫
          if (!layer.isBase && layer.layerKey === keyInfo.code) {
            keyEl.classList.add('layer-key');
          }

          // ÈÅ∏ÊäûÁä∂ÊÖã
          if (selectionMode === 'input' && inputKeys.includes(keyInfo.code)) {
            keyEl.classList.add('input-selected');
          }
          if (selectionMode === 'output' && outputKeys.includes(keyInfo.code)) {
            keyEl.classList.add('output-selected');
          }

          keyEl.onclick = () => handleKeyClick(keyInfo.code);
          keyboard.appendChild(keyEl);
        });
      });
    }

    // „Ç≠„Éº„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
    function handleKeyClick(keyCode) {
      if (selectionMode === 'input') {
        if (inputKeys.includes(keyCode)) {
          inputKeys = inputKeys.filter(k => k !== keyCode);
        } else {
          inputKeys.push(keyCode);
        }
      } else {
        if (outputKeys.includes(keyCode)) {
          outputKeys = outputKeys.filter(k => k !== keyCode);
        } else {
          outputKeys.push(keyCode);
        }
      }
      updateSelectedKeysDisplay();
      renderKeyboard();
    }

    // ÈÅ∏ÊäûË°®Á§∫Êõ¥Êñ∞
    function updateSelectedKeysDisplay() {
      const inputDisplay = document.getElementById('inputKeysDisplay');
      const outputDisplay = document.getElementById('outputKeysDisplay');

      if (inputKeys.length === 0) {
        inputDisplay.innerHTML = '<span style="color: #999;">„Ç≠„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>';
      } else {
        inputDisplay.innerHTML = inputKeys.map(k => 
          `<span class="selection-tag input">${getKeyLabel(k)}</span>`
        ).join('');
      }

      if (outputModifiers.length === 0 && outputKeys.length === 0) {
        outputDisplay.innerHTML = '<span style="color: #999;">„Ç≠„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>';
      } else {
        let html = '';
        
        // ‰øÆÈ£æ„Ç≠„ÉºË°®Á§∫
        if (outputModifiers.length > 0) {
          html += outputModifiers.map(m => {
            const mod = modifierKeys.find(mk => mk.code === m);
            return `<span class="selection-tag output">${mod ? mod.label : m}</span>`;
          }).join('');
        }
        
        // „Éó„É©„ÇπË®òÂè∑
        if (outputModifiers.length > 0 && outputKeys.length > 0) {
          html += '<span style="margin: 0 5px; font-weight: bold;">+</span>';
        }
        
        // ÈÄöÂ∏∏„Ç≠„ÉºË°®Á§∫
        if (outputKeys.length > 0) {
          html += outputKeys.map(k => 
            `<span class="selection-tag output">${getKeyLabel(k)}</span>`
          ).join('');
        }
        
        outputDisplay.innerHTML = html;
      }
    }

    // ÈÅ∏Êäû„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
    function setSelectionMode(mode) {
      selectionMode = mode;
      const inputBtn = document.getElementById('inputModeBtn');
      const outputBtn = document.getElementById('outputModeBtn');

      inputBtn.className = 'mode-btn';
      outputBtn.className = 'mode-btn';

      if (mode === 'input') {
        inputBtn.classList.add('active-input');
      }

      renderKeyboard();
    }

    // „Ç≠„Éº„Éú„Éº„Éâ„É¨„Ç§„Ç¢„Ç¶„ÉàÂàá„ÇäÊõø„Åà
    function changeKeyboardLayout() {
      const select = document.getElementById('keyboardLayoutSelect');
      currentLayout = select.value;
      keyboardLayout = keyboardLayouts[currentLayout];
      
      // „É¨„Ç§„É§„Éº„Ç≠„ÉºÈÅ∏ÊäûËÇ¢„ÇíÂÜçÁîüÊàê
      populateLayerKeySelect();
      
      // ÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
      clearSelection();
      
      // „Ç≠„Éº„Éú„Éº„Éâ„ÇíÂÜçÊèèÁîª
      renderKeyboard();
    }

    // „Éû„ÉÉ„Éî„É≥„Ç∞ËøΩÂä†
    function addMapping() {
      const layer = layers.find(l => l.id === currentLayerId);
      if (!layer) return false;

      if (inputKeys.length === 0 || (outputKeys.length === 0 && outputModifiers.length === 0)) {
        alert('ÂÖ•Âäõ„Ç≠„Éº„Å®Âá∫Âäõ„Ç≠„Éº„Çí‰∏°ÊñπÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return false;
      }

      // Á´∂Âêà„ÉÅ„Çß„ÉÉ„ÇØÔºöÂÖ•Âäõ„Ç≠„Éº„ÅÆÂÆåÂÖ®‰∏ÄËá¥
      const existingMappingIndex = layer.mappings.findIndex(m => {
        // ÂÖ•Âäõ„Ç≠„Éº„ÅÆÊï∞„ÅåÁï∞„Å™„Çå„Å∞Âà•„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞
        if (m.input.length !== inputKeys.length) return false;
        
        // „Åô„Åπ„Å¶„ÅÆ„Ç≠„Éº„Åå‰∏ÄËá¥„Åô„Çã„ÅãÁ¢∫Ë™çÔºàÈ†ÜÂ∫è„ÅØÂïè„Çè„Å™„ÅÑÔºâ
        const sorted1 = [...m.input].sort();
        const sorted2 = [...inputKeys].sort();
        return sorted1.every((key, i) => key === sorted2[i]);
      });

      if (existingMappingIndex !== -1) {
        const existing = layer.mappings[existingMappingIndex];
        
        // Êó¢Â≠ò„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞ÊÉÖÂ†±„ÇíË°®Á§∫
        const inputStr = inputKeys.map(k => getKeyLabel(k)).join('+');
        let existingOutputStr = '';
        if (existing.outputModifiers && existing.outputModifiers.length > 0) {
          existingOutputStr = existing.outputModifiers.map(m => {
            const mod = modifierKeys.find(mk => mk.code === m);
            return mod ? mod.label : m;
          }).join('+');
          if (existing.output.length > 0) {
            existingOutputStr += '+';
          }
        }
        existingOutputStr += existing.output.map(k => getKeyLabel(k)).join('+');
        
        let newOutputStr = '';
        if (outputModifiers.length > 0) {
          newOutputStr = outputModifiers.map(m => {
            const mod = modifierKeys.find(mk => mk.code === m);
            return mod ? mod.label : m;
          }).join('+');
          if (outputKeys.length > 0) {
            newOutputStr += '+';
          }
        }
        newOutputStr += outputKeys.map(k => getKeyLabel(k)).join('+');
        
        const confirmMsg = `ÂÖ•Âäõ„Ç≠„Éº„Äå${inputStr}„Äç„ÅØÊó¢„Å´„Éû„ÉÉ„Éî„É≥„Ç∞„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n\n` +
                          `ÁèæÂú®: ${inputStr} ‚Üí ${existingOutputStr}\n` +
                          `Êñ∞Ë¶è: ${inputStr} ‚Üí ${newOutputStr}\n\n` +
                          `‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü`;
        
        if (!confirm(confirmMsg)) {
          // „Ç≠„É£„É≥„Çª„É´„Åï„Çå„ÅüÂ†¥Âêà„ÄÅfalse„ÇíËøî„Åô
          return false;
        }
        
        // ‰∏äÊõ∏„ÅçÔºàÊó¢Â≠ò„ÇíÂâäÈô§„Åó„Å¶„Åã„ÇâËøΩÂä†Ôºâ
        layer.mappings.splice(existingMappingIndex, 1);
      }

      const mapping = {
        input: [...inputKeys],
        output: [...outputKeys],
        outputModifiers: [...outputModifiers]
      };

      layer.mappings.push(mapping);
      clearSelection();
      updateMappingList();
      generateAHK();
      renderKeyboard();
      return true;
    }

    // ÈÅ∏Êäû„ÇØ„É™„Ç¢
    function clearSelection() {
      inputKeys = [];
      outputKeys = [];
      outputModifiers = [];
      updateSelectedKeysDisplay();
      renderKeyboard();
    }

    // ÂÖ®„Éû„ÉÉ„Éî„É≥„Ç∞„ÇØ„É™„Ç¢
    function clearAllMappings() {
      if (!confirm('„Åô„Åπ„Å¶„ÅÆ„É¨„Ç§„É§„Éº„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) return;
      
      layers.forEach(layer => {
        layer.mappings = [];
      });
      
      clearSelection();
      updateMappingList();
      generateAHK();
      renderKeyboard();
    }

    // „Éû„ÉÉ„Éî„É≥„Ç∞„É™„Çπ„ÉàÊõ¥Êñ∞
    function updateMappingList() {
      const list = document.getElementById('mappingList');
      list.innerHTML = '';

      const layer = layers.find(l => l.id === currentLayerId);
      if (!layer) return;

      layer.mappings.forEach((mapping, index) => {
        const li = document.createElement('li');
        li.className = 'mapping-item';

        const info = document.createElement('div');
        info.className = 'mapping-info';

        const keysDiv = document.createElement('div');
        keysDiv.className = 'mapping-keys';

        const inputStr = mapping.input.map(k => getKeyLabel(k)).join('+');
        
        // Âá∫Âäõ„ÇíÊï¥ÂΩ¢Ôºà‰øÆÈ£æ„Ç≠„ÉºÂØæÂøúÔºâ
        let outputStr = '';
        if (mapping.outputModifiers && mapping.outputModifiers.length > 0) {
          outputStr = mapping.outputModifiers.map(m => {
            const mod = modifierKeys.find(mk => mk.code === m);
            return mod ? mod.label : m;
          }).join('+');
          if (mapping.output.length > 0) {
            outputStr += '+';
          }
        }
        outputStr += mapping.output.map(k => getKeyLabel(k)).join('+');

        keysDiv.innerHTML = `${inputStr} <span class="mapping-arrow">‚Üí</span> ${outputStr}`;
        info.appendChild(keysDiv);
        li.appendChild(info);

        // „Éú„Çø„É≥„Ç≥„É≥„ÉÜ„Éä
        const btnContainer = document.createElement('div');
        btnContainer.style.display = 'flex';
        btnContainer.style.gap = '10px';

        // Á∑®ÈõÜ„Éú„Çø„É≥
        const editBtn = document.createElement('button');
        editBtn.className = 'delete-btn';
        editBtn.style.background = '#4CAF50';
        editBtn.textContent = 'Á∑®ÈõÜ';
        editBtn.onclick = () => editMapping(index);
        btnContainer.appendChild(editBtn);

        // ÂâäÈô§„Éú„Çø„É≥
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'ÂâäÈô§';
        deleteBtn.onclick = () => deleteMapping(index);
        btnContainer.appendChild(deleteBtn);

        li.appendChild(btnContainer);
        list.appendChild(li);
      });
    }

    // „Éû„ÉÉ„Éî„É≥„Ç∞ÂâäÈô§
    function deleteMapping(index) {
      const layer = layers.find(l => l.id === currentLayerId);
      if (!layer) return;

      layer.mappings.splice(index, 1);
      updateMappingList();
      generateAHK();
      renderKeyboard();
    }

    // „Éû„ÉÉ„Éî„É≥„Ç∞Á∑®ÈõÜ
    function editMapping(index) {
      const layer = layers.find(l => l.id === currentLayerId);
      if (!layer) return;

      const mapping = layer.mappings[index];
      
      // ÁèæÂú®„ÅÆÈÅ∏Êäû„Çí„Éû„ÉÉ„Éî„É≥„Ç∞„ÅÆÂÄ§„Åß‰∏äÊõ∏„Åç
      inputKeys = [...mapping.input];
      outputKeys = [...mapping.output];
      outputModifiers = mapping.outputModifiers ? [...mapping.outputModifiers] : [];
      
      // UI„ÇíÊõ¥Êñ∞
      updateSelectedKeysDisplay();
      renderKeyboard();
      
      // „Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÂâäÈô§ÔºàÁ∑®ÈõÜ„É¢„Éº„ÉâÔºâ
      layer.mappings.splice(index, 1);
      updateMappingList();
      generateAHK();
      
      // „É¶„Éº„Ç∂„Éº„Å´ÈÄöÁü•
      alert('„Éû„ÉÉ„Éî„É≥„Ç∞„ÅåÁ∑®ÈõÜ„É¢„Éº„Éâ„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇÂ§âÊõ¥Âæå„Äå„Éû„ÉÉ„Éî„É≥„Ç∞ËøΩÂä†„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    }

    // AHKÁîüÊàê
    function generateAHK() {
      // AutoHotkey„ÅßÁâπÊÆä„Å™ÊÑèÂë≥„ÇíÊåÅ„Å§ÊñáÂ≠ó„Çí„Ç®„Çπ„Ç±„Éº„Éó„Åô„ÇãÈñ¢Êï∞
      function escapeAhkKey(ahkKey) {
        const needsEscape = [';'];  // „Çª„Éü„Ç≥„É≠„É≥„ÅØ„Ç≥„É°„É≥„ÉàË®òÂè∑„Å™„ÅÆ„Åß„Ç®„Çπ„Ç±„Éº„ÉóÂøÖË¶Å
        if (needsEscape.includes(ahkKey)) {
          return `{${ahkKey}}`;
        }
        return ahkKey;
      }
      
      // SC„Ç≥„Éº„Éâ‚ÜíVK„Ç≥„Éº„ÉâÂ§âÊèõ„Éû„ÉÉ„ÉóÔºàKeyWaitÁî®Ôºâ
      const scToVk = {
        'sc079': 'vk1C',   // ConvertÔºàÂ§âÊèõÔºâ
        'sc07B': 'vkEB',   // NonConvertÔºàÁÑ°Â§âÊèõÔºâ
        'sc027': 'sc027'   // SemicolonÔºà„Çª„Éü„Ç≥„É≠„É≥ÔºâJISÈÖçÂàó - SC„Ç≥„Éº„Éâ„ÅÆ„Åæ„Åæ‰ΩøÁî®
      };
      
      // KeyWaitÁî®„ÅÆ„Ç≠„ÉºÂêç„ÇíÂèñÂæóÔºàSC„Ç≥„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØVK„Ç≥„Éº„Éâ„Å´Â§âÊèõÔºâ
      function getKeyWaitName(ahkKey) {
        if (scToVk[ahkKey]) {
          return scToVk[ahkKey];
        }
        return ahkKey;
      }
      
      let script = '; AutoHotkey v2 Layer Keymap Script\n';
      script += '; Generated by AutoHotkey v2 Layer Keymap Editor\n';
      script += '#Requires AutoHotkey v2.0\n';
      script += 'SendMode "Input"\n';
      script += 'SetWorkingDir A_ScriptDir\n';
      script += 'InstallKeybdHook\n';
      script += 'ProcessSetPriority "High"\n';
      script += '\n';
      
      // CapsLock„Åå„É¨„Ç§„É§„Éº„Ç≠„Éº„Å®„Åó„Å¶‰Ωø„Çè„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Çπ„ÇØ„É™„Éó„ÉàËµ∑ÂãïÊôÇ„Å´Ë®≠ÂÆö
      const capsLockUsedAsLayer = layers.some(l => !l.isBase && l.layerKey === 'CapsLock');
      if (capsLockUsedAsLayer) {
        script += 'SetCapsLockState "AlwaysOff"\n';
      }
      script += '\n';
      
      // „É¨„Ç§„É§„Éº„Ç≠„Éº„Å®„Åó„Å¶‰Ωø„Çè„Çå„Å¶„ÅÑ„Çã„Ç≠„Éº„ÅÆ„É™„Çπ„Éà
      const layerKeys = new Set();
      layers.forEach(l => {
        if (!l.isBase && l.layerKey) {
          layerKeys.add(l.layerKey);
        }
      });
      
      // Base Layer„ÅÆÂá¶ÁêÜ
      const baseLayer = layers.find(l => l.isBase);
      if (baseLayer && baseLayer.mappings.length > 0) {
        script += `; ${baseLayer.name}\n`;
        
        // Base Layer„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÂá¶ÁêÜ
        baseLayer.mappings.forEach(mapping => {
          if (mapping.output.length === 1 && mapping.output[0] === 'Disable') {
            if (mapping.input.length === 1) {
              const keyCode = mapping.input[0];
              const ahkKey = ahkKeyMap[keyCode] || keyCode;
              const isLayerKey = layerKeys.has(keyCode);
              
              if (isLayerKey) {
                // „É¨„Ç§„É§„Éº„Ç≠„Éº„ÅÆÂ†¥Âêà„ÅØCapsLock„ÅÆ„ÅøÁÑ°ÂäπÂåñ
                if (keyCode === 'CapsLock') {
                  script += `${ahkKey}::return\n`;
                } else {
                  // CapsLock‰ª•Â§ñ„ÅÆ„É¨„Ç§„É§„Éº„Ç≠„Éº„ÅØÁÑ°ÂäπÂåñ„Åó„Å™„ÅÑÔºà„Ç≥„É°„É≥„Éà„ÅÆ„ÅøÔºâ
                  script += `; ${ahkKey} is used as layer key (not disabled to avoid conflicts)\n`;
                }
              } else {
                // ÈÄöÂ∏∏„ÅÆÁÑ°ÂäπÂåñ
                if (keyCode === 'CapsLock') {
                  script += `${ahkKey}:: {\n`;
                  script += `  SetCapsLockState "AlwaysOff"\n`;
                  script += `}\n`;
                } else {
                  script += `${ahkKey}::return\n`;
                }
              }
            }
          }
        });
        
        // CapsLock‰ª•Â§ñ„ÅÆ„É¨„Ç§„É§„Éº„Ç≠„Éº„ÅØÂÆöÁæ©„Åó„Å™„ÅÑ
        // ÔºàÂçòÁã¨Êäº„Åó„ÅßÊú¨Êù•„ÅÆÊ©üËÉΩ„ÅåÁô∫Âãï„Åô„Çã„Åå„ÄÅÁ´∂Âêà„ÇíÈÅø„Åë„Çã„Åü„ÇÅÔºâ
        
        script += '\n';
      }

      // ÈùûBase„É¨„Ç§„É§„Éº„ÅÆÂá¶ÁêÜ
      layers.forEach((layer, layerIndex) => {
        if (layer.isBase || layer.mappings.length === 0) return;

        script += `; ${layer.name}\n`;
        
        // „É¨„Ç§„É§„Éº„Ç≠„Éº„ÅÆÂÆöÁæ©„ÅØ„Åó„Å™„ÅÑÔºàÊó¢„Å´Base Layer„ÅßÂÆöÁæ©Ê∏à„ÅøÔºâ

        layer.mappings.forEach(mapping => {
          let inputStr = '';
          let isLayerKeyCombo = false;  // „É¨„Ç§„É§„Éº„Ç≠„ÉºÂêåÂ£´„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„Åã
          
          // „É¨„Ç§„É§„Éº„Ç≠„Éº„ÇíÂâçÁΩÆ
          if (!layer.isBase && layer.layerKey) {
            const layerAhkKey = ahkKeyMap[layer.layerKey] || layer.layerKey.toLowerCase();
            const escapedLayerKey = escapeAhkKey(layerAhkKey);
            inputStr = escapedLayerKey;
          }

          // ÂÖ•Âäõ„Ç≠„Éº„Åå„É¨„Ç§„É§„Éº„Ç≠„Éº„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if (mapping.input.length === 1 && layerKeys.has(mapping.input[0])) {
            isLayerKeyCombo = true;
          }

          // ÂÖ•Âäõ„Ç≠„Éº
          mapping.input.forEach((key, i) => {
            const ahkKey = ahkKeyMap[key] || key.toLowerCase();
            const escapedKey = escapeAhkKey(ahkKey);
            if (inputStr) inputStr += ' & ';
            inputStr += escapedKey;
          });

          // ÁÑ°ÂäπÂåñ„ÉÅ„Çß„ÉÉ„ÇØ
          if (mapping.output.length === 1 && mapping.output[0] === 'Disable') {
            // ÂçòÁã¨„Ç≠„Éº„ÅÆÁÑ°ÂäπÂåñ
            if (mapping.input.length === 1) {
              const keyCode = mapping.input[0];
              const ahkKey = ahkKeyMap[keyCode] || keyCode;
              
              // „Åì„ÅÆ„Ç≠„Éº„Åå„É¨„Ç§„É§„Éº„Ç≠„Éº„Å®„Åó„Å¶‰Ωø„Çè„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
              const isLayerKey = layerKeys.has(keyCode);
              
              if (isLayerKey) {
                // „É¨„Ç§„É§„Éº„Ç≠„Éº„ÅÆÂ†¥Âêà„ÅØ„ÄÅÂêÑ„É¨„Ç§„É§„Éº„ÅÆÁõ¥Ââç„ÅßÂÆöÁæ©„Åï„Çå„Çã„ÅÆ„Åß„Çπ„Ç≠„ÉÉ„Éó
                script += `; ${ahkKey} is defined as layer key\n`;
              } else {
                // ÈÄöÂ∏∏„ÅÆÁÑ°ÂäπÂåñ
                if (keyCode === 'CapsLock') {
                  script += `${ahkKey}:: {\n`;
                  script += `  SetCapsLockState "AlwaysOff"\n`;
                  script += `}\n`;
                } else {
                  script += `${ahkKey}::return\n`;
                }
              }
            } else {
              // Ë§áÊï∞„Ç≠„Éº„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÅÆÁÑ°ÂäπÂåñ
              script += `${inputStr}::return\n`;
            }
            return;
          }

          // „Éû„Ç¶„Çπ„Éõ„Ç§„Éº„É´Êìç‰Ωú
          if (mapping.output.length === 1 && ['WheelUp', 'WheelDown', 'WheelLeft', 'WheelRight'].includes(mapping.output[0])) {
            const wheelAction = mapping.output[0];
            
            // „É¨„Ç§„É§„Éº„Ç≠„ÉºÂêåÂ£´„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÅÆÂ†¥Âêà„ÅØ#HotIfÊßãÊñá
            if (isLayerKeyCombo && !layer.isBase && layer.layerKey) {
              const layerAhkKey = ahkKeyMap[layer.layerKey] || layer.layerKey.toLowerCase();
              const inputKeyCode = mapping.input[0];
              const inputAhkKey = ahkKeyMap[inputKeyCode] || inputKeyCode.toLowerCase();
              const escapedInputKey = escapeAhkKey(inputAhkKey);
              
              script += `#HotIf GetKeyState("${layerAhkKey}", "P")\n`;
              script += `${escapedInputKey}::Click("${wheelAction}")\n`;
              script += `#HotIf\n`;
            } else if (!layer.isBase && layer.layerKey) {
              // ÈÄöÂ∏∏„ÅÆ„É¨„Ç§„É§„Éº„Ç≠„ÉºÁµÑ„ÅøÂêà„Çè„Åõ
              script += `${inputStr}::Click("${wheelAction}")\n`;
            } else {
              // ÂçòÁã¨„Ç≠„Éº„ÅÆÂ†¥Âêà
              script += `${inputStr}::${wheelAction}\n`;
            }
            return;
          }

          // „Éû„Ç¶„Çπ„Éú„Çø„É≥Êäº„Åó„Å£„Å±„Å™„ÅóÂØæÂøú
          if (mapping.output.length === 1 && (!mapping.outputModifiers || mapping.outputModifiers.length === 0) && 
              ['LButton', 'RButton', 'MButton', 'XButton1', 'XButton2'].includes(mapping.output[0])) {
            const mouseButton = mapping.output[0];
            const lastInputKey = mapping.input[mapping.input.length - 1];
            
            // AHK„Ç≠„ÉºÂêç„ÇíÂèñÂæó
            let checkKey = ahkKeyMap[lastInputKey] || lastInputKey;
            
            // KeyXXXÂΩ¢Âºè„ÅÆÂ†¥Âêà„ÅØÂ∞èÊñáÂ≠ó1ÊñáÂ≠ó„Å´Â§âÊèõ
            if (lastInputKey.startsWith('Key')) {
              checkKey = lastInputKey.substring(3).toLowerCase();
            }
            
            // KeyWaitÁî®„Å´SC„Ç≥„Éº„Éâ„ÇíVK„Ç≥„Éº„Éâ„Å´Â§âÊèõ
            checkKey = getKeyWaitName(checkKey);
            
            let clickType = 'Left';
            if (mouseButton === 'RButton') clickType = 'Right';
            else if (mouseButton === 'MButton') clickType = 'Middle';
            else if (mouseButton === 'XButton1') clickType = 'X1';
            else if (mouseButton === 'XButton2') clickType = 'X2';
            
            // „É¨„Ç§„É§„Éº„Ç≠„ÉºÂêåÂ£´„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÅÆÂ†¥Âêà„ÅØ#HotIfÊßãÊñá
            if (isLayerKeyCombo && !layer.isBase && layer.layerKey) {
              const layerAhkKey = ahkKeyMap[layer.layerKey] || layer.layerKey.toLowerCase();
              const inputAhkKey = ahkKeyMap[lastInputKey] || lastInputKey.toLowerCase();
              const escapedInputKey = escapeAhkKey(inputAhkKey);
              
              script += `#HotIf GetKeyState("${layerAhkKey}", "P")\n`;
              script += `${escapedInputKey}:: {\n`;
              script += `  Click("Down ${clickType}")\n`;
              script += `  KeyWait("${checkKey}")\n`;
              script += `  Click("Up ${clickType}")\n`;
              script += `}\n`;
              script += `#HotIf\n`;
            } else {
              // ÈÄöÂ∏∏„ÅÆÂá¶ÁêÜ
              script += `${inputStr}:: {\n`;
              script += `  Click("Down ${clickType}")\n`;
              script += `  KeyWait("${checkKey}")\n`;
              script += `  Click("Up ${clickType}")\n`;
              script += `}\n`;
            }
            return;
          }

          // Ë®ÄË™ûÂàá„ÇäÊõø„Åà„Ç¢„ÇØ„Ç∑„Éß„É≥
          if (mapping.output.length === 1 && !mapping.outputModifiers?.length) {
            const langSwitch = languageSwitchActions.find(a => a.code === mapping.output[0]);
            if (langSwitch) {
              // „É¨„Ç§„É§„Éº„Ç≠„ÉºÂêåÂ£´„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÅÆÂ†¥Âêà„ÅØ#HotIfÊßãÊñá
              if (isLayerKeyCombo && !layer.isBase && layer.layerKey) {
                const layerAhkKey = ahkKeyMap[layer.layerKey] || layer.layerKey.toLowerCase();
                const inputKeyCode = mapping.input[0];
                const inputAhkKey = ahkKeyMap[inputKeyCode] || inputKeyCode.toLowerCase();
                const escapedInputKey = escapeAhkKey(inputAhkKey);
                
                script += `#HotIf GetKeyState("${layerAhkKey}", "P")\n`;
                script += `${escapedInputKey}::${langSwitch.ahk}\n`;
                script += `#HotIf\n`;
              } else {
                script += `${inputStr}::${langSwitch.ahk}\n`;
              }
              return;
            }
          }

          // „Ç´„Çπ„Çø„É†ÊñáÂ≠óÂàó
          if (mapping.output.length === 1 && !mapping.outputModifiers?.length) {
            const customStr = customStrings.find(s => s.code === mapping.output[0]);
            if (customStr) {
              // „Ç®„Çπ„Ç±„Éº„ÉóÂá¶ÁêÜ
              let escapedValue = customStr.value
                .replace(/\\/g, '\\\\')
                .replace(/"/g, '\\"')
                .replace(/\n/g, '`n')
                .replace(/\r/g, '`r')
                .replace(/\t/g, '`t');
              
              // „É¨„Ç§„É§„Éº„Ç≠„ÉºÂêåÂ£´„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÅÆÂ†¥Âêà„ÅØ#HotIfÊßãÊñá
              if (isLayerKeyCombo && !layer.isBase && layer.layerKey) {
                const layerAhkKey = ahkKeyMap[layer.layerKey] || layer.layerKey.toLowerCase();
                const inputKeyCode = mapping.input[0];
                const inputAhkKey = ahkKeyMap[inputKeyCode] || inputKeyCode.toLowerCase();
                const escapedInputKey = escapeAhkKey(inputAhkKey);
                
                script += `#HotIf GetKeyState("${layerAhkKey}", "P")\n`;
                script += `${escapedInputKey}::SendText("${escapedValue}")\n`;
                script += `#HotIf\n`;
              } else {
                script += `${inputStr}::SendText("${escapedValue}")\n`;
              }
              return;
            }
          }

          // „É°„Éá„Ç£„Ç¢„Ç≠„Éº„Éª„Éñ„É©„Ç¶„Ç∂„Ç≠„ÉºÔºà‰øÆÈ£æ„Ç≠„Éº„Å™„Åó„ÄÅÂçò‰∏Ä„Ç≠„ÉºÔºâ
          if (mapping.output.length === 1 && !mapping.outputModifiers?.length) {
            const outKey = mapping.output[0];
            if (outKey.startsWith('Media_') || outKey.startsWith('Volume_') || 
                outKey.startsWith('Browser_')) {
              const ahkKey = ahkKeyMap[outKey] || outKey;
              script += `${inputStr}::SendEvent("{${ahkKey}}")\n`;
              return;
            }
          }

          // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Ç≠„Éº„ÅÆÂä†ÈÄü‰ªò„ÅçÊäº„ÅóÁ∂ö„ÅëÂá¶ÁêÜ
          // ArrowLeft, ArrowRight, ArrowUp, ArrowDown, Home, End, PageUp, PageDown
          const navigationKeys = ['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End', 'PageUp', 'PageDown'];
          if (mapping.output.length === 1 && (!mapping.outputModifiers || mapping.outputModifiers.length === 0) && 
              navigationKeys.includes(mapping.output[0])) {
            const navKey = mapping.output[0];
            const ahkKey = ahkKeyMap[navKey] || navKey;
            const lastInputKey = mapping.input[mapping.input.length - 1];
            
            // ÂÖ•Âäõ„Ç≠„Éº„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÁî®„Ç≠„ÉºÂêç„ÇíÂèñÂæó
            let checkKey = ahkKeyMap[lastInputKey] || lastInputKey;
            if (lastInputKey.startsWith('Key')) {
              checkKey = lastInputKey.substring(3).toLowerCase();
            }
            
            // „É¨„Ç§„É§„Éº„Ç≠„ÉºÂêåÂ£´„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÅÆÂ†¥Âêà„ÅØ#HotIfÊßãÊñá
            if (isLayerKeyCombo && !layer.isBase && layer.layerKey) {
              const layerAhkKey = ahkKeyMap[layer.layerKey] || layer.layerKey.toLowerCase();
              const inputAhkKey = ahkKeyMap[lastInputKey] || lastInputKey.toLowerCase();
              const escapedInputKey = escapeAhkKey(inputAhkKey);
              
              script += `#HotIf GetKeyState("${layerAhkKey}", "P")\n`;
              script += `${escapedInputKey}:: {\n`;
              script += `  modifiers := ""\n`;
              script += `  if GetKeyState("Shift", "P")\n`;
              script += `    modifiers .= "+"\n`;
              script += `  if GetKeyState("Ctrl", "P")\n`;
              script += `    modifiers .= "^"\n`;
              script += `  if GetKeyState("Alt", "P")\n`;
              script += `    modifiers .= "!"\n`;
              script += `  \n`;
              script += `  SendEvent(modifiers . "{${ahkKey}}")\n`;
              script += `}\n`;
              script += `#HotIf\n`;
            } else {
              // ÈÄöÂ∏∏„ÅÆÂá¶ÁêÜ
              script += `${inputStr}:: {\n`;
              script += `  modifiers := ""\n`;
              script += `  if GetKeyState("Shift", "P")\n`;
              script += `    modifiers .= "+"\n`;
              script += `  if GetKeyState("Ctrl", "P")\n`;
              script += `    modifiers .= "^"\n`;
              script += `  if GetKeyState("Alt", "P")\n`;
              script += `    modifiers .= "!"\n`;
              script += `  \n`;
              script += `  SendEvent(modifiers . "{${ahkKey}}")\n`;
              script += `}\n`;
            }
            return;
          }

          // ÈÄöÂ∏∏„ÅÆÂá∫Âäõ„Ç≠„ÉºÔºà‰øÆÈ£æ„Ç≠„ÉºÂØæÂøúÔºâ
          let outputStr = '';
          
          // „É¨„Ç§„É§„Éº„Ç≠„ÉºÂêåÂ£´„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÅÆÂ†¥Âêà„ÅØ#HotIfÊßãÊñá„Çí‰ΩøÁî®
          if (isLayerKeyCombo && !layer.isBase && layer.layerKey) {
            // #HotIf„Éá„Ç£„É¨„ÇØ„ÉÜ„Ç£„Éñ„Çí‰Ωø„Å£„ÅüÂÆüË£Ö
            const layerAhkKey = ahkKeyMap[layer.layerKey] || layer.layerKey.toLowerCase();
            const inputKeyCode = mapping.input[0];
            const inputAhkKey = ahkKeyMap[inputKeyCode] || inputKeyCode.toLowerCase();
            const escapedInputKey = escapeAhkKey(inputAhkKey);
            
            script += `#HotIf GetKeyState("${layerAhkKey}", "P")\n`;
            
            // Âá∫Âäõ„ÇíÁîüÊàê
            let ifOutputStr = '';
            if (mapping.outputModifiers && mapping.outputModifiers.length > 0) {
              mapping.outputModifiers.forEach(mod => {
                const modKey = modifierKeys.find(m => m.code === mod);
                if (modKey) {
                  ifOutputStr += modKey.ahk;
                }
              });
            }
            
            if (mapping.output.length === 1 && mapping.outputModifiers?.length > 0) {
              const ahkKey = ahkKeyMap[mapping.output[0]] || mapping.output[0].toLowerCase();
              ifOutputStr += ahkKey;
            } else if (mapping.output.length === 1) {
              const ahkKey = ahkKeyMap[mapping.output[0]] || mapping.output[0].toLowerCase();
              ifOutputStr += `{${ahkKey}}`;
            } else {
              mapping.output.forEach(key => {
                const ahkKey = ahkKeyMap[key] || key.toLowerCase();
                ifOutputStr += `{${ahkKey}}`;
              });
            }
            
            script += `${escapedInputKey}::SendEvent("${ifOutputStr}")\n`;
            script += `#HotIf\n`;
            return;
          }
          
          // ‰øÆÈ£æ„Ç≠„Éº„Ç∑„É≥„Éú„É´„ÇíÂâçÁΩÆ
          if (mapping.outputModifiers && mapping.outputModifiers.length > 0) {
            mapping.outputModifiers.forEach(mod => {
              const modKey = modifierKeys.find(m => m.code === mod);
              if (modKey) {
                outputStr += modKey.ahk;
              }
            });
          }
          
          // Âá∫Âäõ„Ç≠„Éº
          if (mapping.output.length === 1 && mapping.outputModifiers?.length > 0) {
            // ‰øÆÈ£æ„Ç≠„Éº + Âçò‰∏Ä„Ç≠„Éº„ÅÆÂ†¥ÂêàÔºàSend ^a„ÅÆ„Çà„ÅÜ„Å™ÂΩ¢ÂºèÔºâ
            const ahkKey = ahkKeyMap[mapping.output[0]] || mapping.output[0].toLowerCase();
            outputStr += ahkKey;
          } else if (mapping.output.length === 1) {
            // Âçò‰∏Ä„Ç≠„Éº„ÅÆ„Åø
            const ahkKey = ahkKeyMap[mapping.output[0]] || mapping.output[0].toLowerCase();
            outputStr += `{${ahkKey}}`;
          } else {
            // Ë§áÊï∞„Ç≠„Éº
            mapping.output.forEach(key => {
              const ahkKey = ahkKeyMap[key] || key.toLowerCase();
              outputStr += `{${ahkKey}}`;
            });
          }

          script += `${inputStr}::SendEvent("${outputStr}")\n`;
        });

        script += '\n';
      });

      document.getElementById('ahkOutput').textContent = script;
    }

    // „Ç≠„Éº„É©„Éô„É´ÂèñÂæó
    function getKeyLabel(keyCode) {
      // ÁâπÊÆä„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅÆÂ†¥Âêà
      if (specialActionLabels[keyCode]) {
        return specialActionLabels[keyCode];
      }
      
      const keyInfo = keyboardLayout.flat().find(k => k.code === keyCode);
      return keyInfo ? keyInfo.label : keyCode;
    }

    // AHK„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
    function downloadAHK() {
      const script = document.getElementById('ahkOutput').textContent;
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const scriptBytes = new TextEncoder().encode(script);
      const blob = new Blob([bom, scriptBytes], { type: 'text/plain;charset=utf-8' });
      
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      // „Éï„Ç°„Ç§„É´Âêç„Å´Êó•ÊôÇ„ÇíÂê´„ÇÅ„Çã (‰æã: layer-keymap-v2_20250120_143025.ahk)
      const now = new Date();
      const dateStr = now.getFullYear() + 
                     String(now.getMonth() + 1).padStart(2, '0') + 
                     String(now.getDate()).padStart(2, '0') + '_' +
                     String(now.getHours()).padStart(2, '0') + 
                     String(now.getMinutes()).padStart(2, '0') + 
                     String(now.getSeconds()).padStart(2, '0');
      a.download = `layer-keymap-v2_${dateStr}.ahk`;
      
      a.click();
      URL.revokeObjectURL(url);
    }

    // JSON‰øùÂ≠ò
    function saveJSON() {
      const now = new Date();
      const timestamp = now.toISOString();
      
      const data = { 
        version: EDITOR_VERSION,
        created: timestamp,
        layers,
        currentLayout,
        customStrings
      };
      
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      // „Éï„Ç°„Ç§„É´Âêç„Å´Êó•ÊôÇ„ÇíÂê´„ÇÅ„Çã (‰æã: keymap-layers_20250120_143025.json)
      const dateStr = now.getFullYear() + 
                     String(now.getMonth() + 1).padStart(2, '0') + 
                     String(now.getDate()).padStart(2, '0') + '_' +
                     String(now.getHours()).padStart(2, '0') + 
                     String(now.getMinutes()).padStart(2, '0') + 
                     String(now.getSeconds()).padStart(2, '0');
      a.download = `keymap-layers_${dateStr}.json`;
      
      a.click();
      URL.revokeObjectURL(url);
    }

    // JSONË™≠Ëæº
    function loadJSON(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          // „Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØ
          const loadedVersion = data.version || '0.0.0';
          console.log(`Loading JSON version: ${loadedVersion} (Current: ${EDITOR_VERSION})`);
          
          // „Éê„Éº„Ç∏„Éß„É≥Ë≠¶ÂëäÔºà„É°„Ç∏„É£„Éº„Éê„Éº„Ç∏„Éß„É≥„ÅåÁï∞„Å™„ÇãÂ†¥ÂêàÔºâ
          const loadedMajor = parseInt(loadedVersion.split('.')[0]);
          const currentMajor = parseInt(EDITOR_VERSION.split('.')[0]);
          
          if (loadedMajor < currentMajor) {
            const proceed = confirm(
              `Âè§„ÅÑ„Éê„Éº„Ç∏„Éß„É≥ (v${loadedVersion}) „Åß‰ΩúÊàê„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„Åß„Åô„ÄÇ\n` +
              `ÁèæÂú®„ÅÆ„Éê„Éº„Ç∏„Éß„É≥: v${EDITOR_VERSION}\n\n` +
              `Ë™≠„ÅøËæº„Åø„Åæ„Åô„ÅãÔºü\n` +
              `ÔºàAHK„Çπ„ÇØ„É™„Éó„Éà„ÅØÊúÄÊñ∞„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„ÅßÂÜçÁîüÊàê„Åï„Çå„Åæ„ÅôÔºâ`
            );
            if (!proceed) return;
          }
          
          layers = data.layers;
          currentLayerId = layers[0].id;
          nextLayerId = Math.max(...layers.map(l => l.id)) + 1;
          
          // „Ç´„Çπ„Çø„É†ÊñáÂ≠óÂàó„ÇíÂæ©ÂÖÉ
          if (data.customStrings) {
            customStrings = data.customStrings;
            // Ê¨°„ÅÆID„ÇíÊõ¥Êñ∞
            if (customStrings.length > 0) {
              nextCustomStringId = Math.max(...customStrings.map(s => s.id)) + 1;
            }
          }
          
          // „Ç≠„Éº„Éú„Éº„Éâ„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíÂæ©ÂÖÉ
          if (data.currentLayout) {
            currentLayout = data.currentLayout;
            keyboardLayout = keyboardLayouts[currentLayout];
            document.getElementById('keyboardLayoutSelect').value = currentLayout;
          }
          
          renderLayerTabs();
          renderLayerSettings();
          renderKeyboard();
          clearSelection();
          updateMappingList();
          
          // Âº∑Âà∂ÁöÑ„Å´AHK„Çπ„ÇØ„É™„Éó„Éà„ÇíÂÜçÁîüÊàêÔºàÊúÄÊñ∞„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„ÅßÔºâ
          generateAHK();
          
          // Ë™≠„ÅøËæº„ÅøÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
          console.log('JSON loaded successfully and AHK script regenerated with latest logic');
          
        } catch (error) {
          alert('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          console.error(error);
        }
      };
      reader.readAsText(file);
    }

    // Ëµ∑Âãï
    
    // „É¢„Éº„ÉÄ„É´‰∏ÄÊôÇÈÅ∏Êäû
    let tempOutputKeys = [];
    let tempOutputModifiers = [];

    // ‰øÆÈ£æ„Ç≠„ÉºÂÆöÁæ©
    const modifierKeys = [
      { code: 'ctrl', label: 'Ctrl', ahk: '^' },
      { code: 'shift', label: 'Shift', ahk: '+' },
      { code: 'alt', label: 'Alt', ahk: '!' },
      { code: 'win', label: 'Win', ahk: '#' }
    ];

    // „É¢„Éº„ÉÄ„É´Áî®„Ç¢„ÇØ„Ç∑„Éß„É≥ÂÆöÁæ©
    const modalActions = {
      mouse: [
        { code: 'LButton', label: 'üñ±Ô∏è Â∑¶„ÇØ„É™„ÉÉ„ÇØ' },
        { code: 'RButton', label: 'üñ±Ô∏è Âè≥„ÇØ„É™„ÉÉ„ÇØ' },
        { code: 'MButton', label: 'üñ±Ô∏è ‰∏≠„ÇØ„É™„ÉÉ„ÇØ' },
        { code: 'XButton1', label: 'üñ±Ô∏è Êàª„Çã' },
        { code: 'XButton2', label: 'üñ±Ô∏è ÈÄ≤„ÇÄ' },
        { code: 'WheelUp', label: 'üñ±Ô∏è „Éõ„Ç§„Éº„É´‚Üë' },
        { code: 'WheelDown', label: 'üñ±Ô∏è „Éõ„Ç§„Éº„É´‚Üì' },
        { code: 'WheelLeft', label: 'üñ±Ô∏è „Éõ„Ç§„Éº„É´‚Üê' },
        { code: 'WheelRight', label: 'üñ±Ô∏è „Éõ„Ç§„Éº„É´‚Üí' },
      ],
      media: [
        { code: 'Media_Play_Pause', label: '‚èØÔ∏è ÂÜçÁîü/ÂÅúÊ≠¢' },
        { code: 'Media_Stop', label: '‚èπÔ∏è ÂÅúÊ≠¢' },
        { code: 'Media_Prev', label: '‚èÆÔ∏è Ââç„ÅÆÊõ≤' },
        { code: 'Media_Next', label: '‚è≠Ô∏è Ê¨°„ÅÆÊõ≤' },
        { code: 'Volume_Up', label: 'üîä Èü≥Èáè+' },
        { code: 'Volume_Down', label: 'üîâ Èü≥Èáè-' },
        { code: 'Volume_Mute', label: 'üîá „Éü„É•„Éº„Éà' },
        { code: 'Browser_Back', label: '‚óÄÔ∏è „Éñ„É©„Ç¶„Ç∂Êàª„Çã' },
        { code: 'Browser_Forward', label: '‚ñ∂Ô∏è „Éñ„É©„Ç¶„Ç∂ÈÄ≤„ÇÄ' },
        { code: 'Browser_Refresh', label: 'üîÑ Êõ¥Êñ∞' },
        { code: 'Browser_Home', label: 'üè† „Éõ„Éº„É†' },
      ],
      special: [
        { code: 'Disable', label: 'üö´ ÁÑ°ÂäπÂåñ' },
      ]
    };

    // „É¢„Éº„ÉÄ„É´ÂàùÊúüÂåñ
    function initModal() {
      renderModalGrids();
    }

    // „É¢„Éº„ÉÄ„É´„Ç∞„É™„ÉÉ„ÉâÊèèÁîª
    function renderModalGrids() {
      // ‰øÆÈ£æ„Ç≠„Éº„Ç∞„É™„ÉÉ„Éâ
      const modGrid = document.getElementById('modifierModalGrid');
      modGrid.innerHTML = '';
      modifierKeys.forEach(mod => {
        const div = document.createElement('div');
        div.className = 'modal-key-item';
        div.textContent = mod.label;
        div.dataset.code = mod.code;
        div.dataset.type = 'modifier';
        div.onclick = () => toggleModalModifier(mod.code);
        modGrid.appendChild(div);
      });

      // „Åô„Åπ„Å¶„ÅÆ„Ç≠„Éº„ÇíÂèñÂæó
      const allKeys = keyboardLayout.flat();
      const uniqueKeys = Array.from(new Map(allKeys.map(k => [k.code, k])).values());
      
      // „Ç≠„Éº„ÇíÂàÜÈ°û
      const functionKeys = uniqueKeys.filter(k => k.code.startsWith('F') && k.code.match(/^F\d+$/));
      const numberKeys = uniqueKeys.filter(k => 
        k.code.startsWith('Digit') || 
        ['Backquote', 'Minus', 'Equal', 'BracketLeft', 'BracketRight', 'Backslash', 'Semicolon', 'Quote', 'Comma', 'Period', 'Slash', 'IntlYen', 'IntlRo'].includes(k.code)
      );
      const letterKeys = uniqueKeys.filter(k => k.code.startsWith('Key'));
      const navKeys = uniqueKeys.filter(k => 
        ['Insert', 'Delete', 'Home', 'End', 'PageUp', 'PageDown', 'ArrowLeft', 'ArrowUp', 'ArrowRight', 'ArrowDown', 
         'Tab', 'CapsLock', 'Enter', 'Backspace', 'Space', 'Escape', 'PrintScreen', 'ScrollLock', 'Pause',
         'Zenkaku', 'NonConvert', 'Convert', 'KanaMode'].includes(k.code)
      );
      const numpadKeys = uniqueKeys.filter(k => 
        k.code.startsWith('Numpad') || k.code === 'NumLock'
      );

      // „Éï„Ç°„É≥„ÇØ„Ç∑„Éß„É≥„Ç≠„Éº„ÇíÊèèÁîªÔºàF1-F12È†ÜÔºâ
      const funcGrid = document.getElementById('functionKeysGrid');
      funcGrid.innerHTML = '';
      functionKeys.sort((a, b) => {
        const aNum = parseInt(a.code.substring(1));
        const bNum = parseInt(b.code.substring(1));
        return aNum - bNum;
      });
      functionKeys.forEach(key => {
        const div = document.createElement('div');
        div.className = 'modal-key-item';
        div.textContent = key.label;
        div.dataset.code = key.code;
        div.onclick = () => toggleModalKey(key.code);
        funcGrid.appendChild(div);
      });

      // Êï∞Â≠ó„ÉªË®òÂè∑„Ç≠„Éº„ÇíÊèèÁîª
      const numGrid = document.getElementById('numberKeysGrid');
      numGrid.innerHTML = '';
      // ÁâπÂÆö„ÅÆÈ†ÜÂ∫è„ÅßË°®Á§∫
      const numberOrder = ['Backquote', 'Digit1', 'Digit2', 'Digit3', 'Digit4', 'Digit5', 'Digit6', 'Digit7', 'Digit8', 'Digit9', 'Digit0', 'Minus', 'Equal', 'IntlYen', 'BracketLeft', 'BracketRight', 'Backslash', 'Semicolon', 'Quote', 'Comma', 'Period', 'Slash', 'IntlRo'];
      numberOrder.forEach(code => {
        const key = numberKeys.find(k => k.code === code);
        if (key) {
          const div = document.createElement('div');
          div.className = 'modal-key-item';
          div.textContent = key.label;
          div.dataset.code = key.code;
          div.onclick = () => toggleModalKey(key.code);
          numGrid.appendChild(div);
        }
      });

      // „Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà„ÇíÊèèÁîªÔºàA-ZÈ†ÜÔºâ
      const letterGrid = document.getElementById('letterKeysGrid');
      letterGrid.innerHTML = '';
      letterKeys.sort((a, b) => a.code.localeCompare(b.code));
      letterKeys.forEach(key => {
        const div = document.createElement('div');
        div.className = 'modal-key-item';
        div.textContent = key.label;
        div.dataset.code = key.code;
        div.onclick = () => toggleModalKey(key.code);
        letterGrid.appendChild(div);
      });

      // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Ç≠„Éº„ÇíÊèèÁîª
      const navGrid = document.getElementById('navKeysGrid');
      navGrid.innerHTML = '';
      const navOrder = ['Escape', 'Tab', 'CapsLock', 'Enter', 'Backspace', 'Space', 'Insert', 'Delete', 'Home', 'End', 'PageUp', 'PageDown', 'ArrowLeft', 'ArrowUp', 'ArrowDown', 'ArrowRight', 'PrintScreen', 'ScrollLock', 'Pause', 'Zenkaku', 'NonConvert', 'Convert', 'KanaMode'];
      navOrder.forEach(code => {
        const key = navKeys.find(k => k.code === code);
        if (key) {
          const div = document.createElement('div');
          div.className = 'modal-key-item';
          div.textContent = key.label;
          div.dataset.code = key.code;
          div.onclick = () => toggleModalKey(key.code);
          navGrid.appendChild(div);
        }
      });

      // „ÉÜ„É≥„Ç≠„Éº„ÇíÊèèÁîª
      const numpadGrid = document.getElementById('numpadKeysGrid');
      numpadGrid.innerHTML = '';
      const numpadOrder = ['NumLock', 'NumpadDivide', 'NumpadMultiply', 'NumpadSubtract', 'Numpad7', 'Numpad8', 'Numpad9', 'NumpadAdd', 'Numpad4', 'Numpad5', 'Numpad6', 'Numpad1', 'Numpad2', 'Numpad3', 'NumpadEnter', 'Numpad0', 'NumpadDecimal'];
      numpadOrder.forEach(code => {
        const key = numpadKeys.find(k => k.code === code);
        if (key) {
          const div = document.createElement('div');
          div.className = 'modal-key-item';
          div.textContent = key.label;
          div.dataset.code = key.code;
          div.onclick = () => toggleModalKey(key.code);
          numpadGrid.appendChild(div);
        }
      });

      // „Éû„Ç¶„Çπ„Ç∞„É™„ÉÉ„Éâ
      const mouseGrid = document.getElementById('mouseModalGrid');
      mouseGrid.innerHTML = '';
      modalActions.mouse.forEach(action => {
        const div = document.createElement('div');
        div.className = 'modal-key-item';
        div.textContent = action.label;
        div.dataset.code = action.code;
        div.onclick = () => toggleModalKey(action.code);
        mouseGrid.appendChild(div);
      });

      // „É°„Éá„Ç£„Ç¢„Ç∞„É™„ÉÉ„Éâ
      const mediaGrid = document.getElementById('mediaModalGrid');
      mediaGrid.innerHTML = '';
      modalActions.media.forEach(action => {
        const div = document.createElement('div');
        div.className = 'modal-key-item';
        div.textContent = action.label;
        div.dataset.code = action.code;
        div.onclick = () => toggleModalKey(action.code);
        mediaGrid.appendChild(div);
      });

      // ÁâπÊÆä„Ç∞„É™„ÉÉ„Éâ
      const specialGrid = document.getElementById('specialModalGrid');
      specialGrid.innerHTML = '';
      modalActions.special.forEach(action => {
        const div = document.createElement('div');
        div.className = 'modal-key-item';
        div.textContent = action.label;
        div.dataset.code = action.code;
        div.onclick = () => toggleModalKey(action.code);
        specialGrid.appendChild(div);
      });

      // Ë®ÄË™ûÂàá„ÇäÊõø„Åà„Ç∞„É™„ÉÉ„Éâ
      renderLanguageSwitchGrid();

      // „Ç´„Çπ„Çø„É†ÊñáÂ≠óÂàó„Ç∞„É™„ÉÉ„Éâ
      renderCustomStringsGrid();
    }

    // „É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
    function openOutputModal() {
      tempOutputKeys = [...outputKeys];
      tempOutputModifiers = [...outputModifiers];
      renderModalGrids(); // „Ç∞„É™„ÉÉ„Éâ„ÇíÂÜçÊèèÁîª
      updateModalUI();
      document.getElementById('outputModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    function closeOutputModal() {
      document.getElementById('outputModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    // „É¢„Éº„ÉÄ„É´ÂÜÖ„Åß„Ç≠„Éº„Çí„Éà„Ç∞„É´
    function toggleModalKey(keyCode) {
      const index = tempOutputKeys.indexOf(keyCode);
      if (index > -1) {
        tempOutputKeys.splice(index, 1);
      } else {
        tempOutputKeys.push(keyCode);
      }
      updateModalUI();
    }

    // „É¢„Éº„ÉÄ„É´ÂÜÖ„Åß‰øÆÈ£æ„Ç≠„Éº„Çí„Éà„Ç∞„É´
    function toggleModalModifier(modCode) {
      const index = tempOutputModifiers.indexOf(modCode);
      if (index > -1) {
        tempOutputModifiers.splice(index, 1);
      } else {
        tempOutputModifiers.push(modCode);
      }
      updateModalUI();
    }

    // „É¢„Éº„ÉÄ„É´UIÊõ¥Êñ∞
    function updateModalUI() {
      // „Åô„Åπ„Å¶„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
      document.querySelectorAll('.modal-key-item').forEach(item => {
        if (item.dataset.type === 'modifier') {
          // ‰øÆÈ£æ„Ç≠„Éº
          if (tempOutputModifiers.includes(item.dataset.code)) {
            item.classList.add('selected');
          } else {
            item.classList.remove('selected');
          }
        } else {
          // ÈÄöÂ∏∏„Ç≠„Éº
          if (tempOutputKeys.includes(item.dataset.code)) {
            item.classList.add('selected');
          } else {
            item.classList.remove('selected');
          }
        }
      });

      // „Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞
      const preview = document.getElementById('outputPreview');
      if (tempOutputModifiers.length === 0 && tempOutputKeys.length === 0) {
        preview.className = 'output-preview empty';
        preview.textContent = 'ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì';
      } else {
        preview.className = 'output-preview';
        preview.innerHTML = '';
        
        // ‰øÆÈ£æ„Ç≠„Éº„ÇíË°®Á§∫
        tempOutputModifiers.forEach(mod => {
          const tag = document.createElement('span');
          tag.className = 'selection-tag output';
          const modKey = modifierKeys.find(m => m.code === mod);
          tag.textContent = modKey ? modKey.label : mod;
          preview.appendChild(tag);
        });
        
        // „Éó„É©„ÇπË®òÂè∑
        if (tempOutputModifiers.length > 0 && tempOutputKeys.length > 0) {
          const plus = document.createElement('span');
          plus.textContent = '+';
          plus.style.margin = '0 5px';
          plus.style.fontWeight = 'bold';
          preview.appendChild(plus);
        }
        
        // ÈÄöÂ∏∏„Ç≠„Éº„ÇíË°®Á§∫
        tempOutputKeys.forEach(key => {
          const tag = document.createElement('span');
          tag.className = 'selection-tag output';
          tag.textContent = getKeyLabel(key);
          preview.appendChild(tag);
        });
      }
    }

    // „É¢„Éº„ÉÄ„É´ÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
    function clearModalSelection() {
      tempOutputKeys = [];
      tempOutputModifiers = [];
      updateModalUI();
    }

    // „É¢„Éº„ÉÄ„É´ÈÅ∏Êäû„ÇíÁ¢∫ÂÆö„Åó„Å¶„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíËøΩÂä†
    function confirmAndAddMapping() {
      // ÂÖ•Âäõ„Ç≠„Éº„ÅÆÁ¢∫Ë™ç
      if (inputKeys.length === 0) {
        alert('ÂÖ•Âäõ„Ç≠„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      
      // Âá∫Âäõ„Ç≠„Éº„ÅÆÁ¢∫Ë™ç
      if (tempOutputModifiers.length === 0 && tempOutputKeys.length === 0) {
        alert('Âá∫Âäõ„Ç≠„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      
      // ‰∏ÄÊôÇÈÅ∏Êäû„ÇíÁ¢∫ÂÆö
      outputKeys = [...tempOutputKeys];
      outputModifiers = [...tempOutputModifiers];
      
      // „Éò„ÉÉ„ÉÄ„Éº„ÅÆÈÅ∏ÊäûË°®Á§∫„ÇíÊõ¥Êñ∞
      updateSelectedKeysDisplay();
      
      // „Éû„ÉÉ„Éî„É≥„Ç∞„ÇíËøΩÂä†ÔºàÊàêÂäü/Â§±Êïó„ÇíÁ¢∫Ë™çÔºâ
      const success = addMapping();
      
      // ÊàêÂäü„Åó„ÅüÂ†¥Âêà„ÅÆ„Åø„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
      if (success) {
        closeOutputModal();
      } else {
        // Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
        clearSelection();
        closeOutputModal();
      }
    }

    // ÊóßconfirmModalSelectionÈñ¢Êï∞Ôºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
    function confirmModalSelection() {
      outputKeys = [...tempOutputKeys];
      outputModifiers = [...tempOutputModifiers];
      updateSelectedKeysDisplay();
      closeOutputModal();
    }

    // Ë®ÄË™ûÂàáÊõøÊ©üËÉΩ
    let currentLang = 'ja';
    
    const translations = {
      ja: {
        headerTitle: 'AutoHotkey v2 Visual Mapper',
        labelLayout: '„Ç≠„Éº„Éú„Éº„ÉâÈÖçÂàó:',
        labelLayerName: '„É¨„Ç§„É§„ÉºÂêç:',
        labelKey: '„É¨„Ç§„É§„Éº„Ç≠„Éº:',
        labelSelectionMode: 'ÈÅ∏Êäû„É¢„Éº„Éâ:',
        labelInputKeys: 'ÂÖ•Âäõ„Ç≠„Éº',
        labelOutputKeys: 'Âá∫Âäõ„Ç≠„Éº',
        layerSettingsTitle: '„É¨„Ç§„É§„ÉºË®≠ÂÆö',
        inputModeBtn: 'ÂÖ•Âäõ„Ç≠„ÉºÈÅ∏Êäû',
        outputModeBtn: 'Âá∫Âäõ„Ç≠„ÉºÈÅ∏Êäû („É¢„Éº„ÉÄ„É´)',
        inputPlaceholder: '„Ç≠„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
        outputPlaceholder: '„Ç≠„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
        layerPlaceholder: '„É¨„Ç§„É§„ÉºÂêç„ÇíÂÖ•Âäõ',
        selectKey: 'ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
        usLayout: 'USÈÖçÂàó',
        jisLayout: 'Êó•Êú¨Ë™ûÈÖçÂàó (JIS)',
        title: 'AutoHotkey v2 Visual Mapper',
        usageHint: 'üí° <strong>‰Ωø„ÅÑÊñπ:</strong> ÂÖ•Âäõ„Ç≠„Éº„ÇíÈÅ∏Êäû ‚Üí „ÄåÂá∫Âäõ„Ç≠„ÉºÈÅ∏Êäû„Äç„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅÑ„Å¶Âá∫Âäõ„ÇíÈÅ∏Êäû ‚Üí „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆ„Äå„Éû„ÉÉ„Éî„É≥„Ç∞ËøΩÂä†„Äç„Éú„Çø„É≥„ÅßÁôªÈå≤',
        mappingListTitle: '„Éû„ÉÉ„Éî„É≥„Ç∞‰∏ÄË¶ß',
        ahkScriptTitle: 'AutoHotkey v2 „Çπ„ÇØ„É™„Éó„Éà',
        downloadBtn: 'üíæ AHKv2„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ',
        saveBtn: 'üìÅ Ë®≠ÂÆö‰øùÂ≠ò (.json)',
        loadBtn: 'üìÇ Ë®≠ÂÆöË™≠Ëæº (.json)',
        btnClearSelection: 'üîÑ ÈÅ∏Êäû„ÇØ„É™„Ç¢',
        btnClearAllMappings: 'üóëÔ∏è ÂÖ®„Éû„ÉÉ„Éî„É≥„Ç∞„ÇØ„É™„Ç¢',
        addLayerBtn: '+ Êñ∞Ë¶è„É¨„Ç§„É§„Éº',
        scriptPlaceholder: '; Visual Mapper„ÅßÁîüÊàê„Åï„Çå„Åü„Çπ„ÇØ„É™„Éó„Éà\n; „Éû„ÉÉ„Éî„É≥„Ç∞„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
      },
      en: {
        headerTitle: 'AutoHotkey v2 Visual Mapper',
        labelLayout: 'Keyboard Layout:',
        labelLayerName: 'Layer Name:',
        labelKey: 'Layer Key:',
        labelSelectionMode: 'Selection Mode:',
        labelInputKeys: 'Input Keys',
        labelOutputKeys: 'Output Keys',
        layerSettingsTitle: 'Layer Settings',
        inputModeBtn: 'Select Input Keys',
        outputModeBtn: 'Select Output Keys (Modal)',
        inputPlaceholder: 'Select a key',
        outputPlaceholder: 'Select a key',
        layerPlaceholder: 'Enter layer name',
        selectKey: 'Please select',
        usLayout: 'US Layout',
        jisLayout: 'Japanese Layout (JIS)',
        title: 'AutoHotkey v2 Visual Mapper',
        usageHint: 'üí° <strong>How to use:</strong> Select input key ‚Üí Click "Select Output Keys" to open modal ‚Üí Select output ‚Üí Click "Add Mapping"',
        mappingListTitle: 'Mapping List',
        ahkScriptTitle: 'AutoHotkey v2 Script',
        downloadBtn: 'üíæ Download AHKv2',
        saveBtn: 'üìÅ Save Settings (.json)',
        loadBtn: 'üìÇ Load Settings (.json)',
        btnClearSelection: 'üîÑ Clear Selection',
        btnClearAllMappings: 'üóëÔ∏è Clear All Mappings',
        addLayerBtn: '+ New Layer',
        scriptPlaceholder: '; Script generated by Visual Mapper\n; Please add mappings'
      }
    };
    
    function toggleLanguage() {
      currentLang = currentLang === 'ja' ? 'en' : 'ja';
      updateLanguage();
    }
    
    function updateLanguage() {
      const lang = translations[currentLang];
      
      // „Éò„ÉÉ„ÉÄ„ÉºË¶ÅÁ¥†„ÇíÊõ¥Êñ∞
      const langBtn = document.getElementById('langBtn');
      if (langBtn) langBtn.textContent = currentLang === 'ja' ? 'JA' : 'EN';
      
      const labelLayout = document.getElementById('labelLayout');
      if (labelLayout) labelLayout.textContent = lang.labelLayout;
      
      const labelLayerName = document.getElementById('labelLayerName');
      if (labelLayerName) labelLayerName.textContent = lang.labelLayerName;
      
      const labelKey = document.getElementById('labelKey');
      if (labelKey) labelKey.textContent = lang.labelKey;
      
      const layerSettingsTitle = document.getElementById('layerSettingsTitle');
      if (layerSettingsTitle) layerSettingsTitle.textContent = lang.layerSettingsTitle;
      
      const labelSelectionMode = document.getElementById('labelSelectionMode');
      if (labelSelectionMode) labelSelectionMode.textContent = lang.labelSelectionMode;
      
      const inputModeBtn = document.getElementById('inputModeBtn');
      if (inputModeBtn) inputModeBtn.textContent = lang.inputModeBtn;
      
      const outputModeBtn = document.getElementById('outputModeBtn');
      if (outputModeBtn) outputModeBtn.textContent = lang.outputModeBtn;
      
      const labelInputKeys = document.getElementById('labelInputKeys');
      if (labelInputKeys) labelInputKeys.textContent = lang.labelInputKeys;
      
      const labelOutputKeys = document.getElementById('labelOutputKeys');
      if (labelOutputKeys) labelOutputKeys.textContent = lang.labelOutputKeys;
      
      // „Çø„Ç§„Éà„É´„ÇíÊõ¥Êñ∞
      document.title = lang.title;
      
      // ‰Ωø„ÅÑÊñπ„Éí„É≥„Éà„ÇíÊõ¥Êñ∞
      const usageHint = document.getElementById('usageHint');
      if (usageHint) usageHint.innerHTML = lang.usageHint;
      
      // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÊõ¥Êñ∞
      const layerName = document.getElementById('layerName');
      if (layerName && !layerName.value) {
        layerName.placeholder = lang.layerPlaceholder;
      }
      
      // „Éû„ÉÉ„Éî„É≥„Ç∞‰∏ÄË¶ß„Çø„Ç§„Éà„É´„ÇíÊõ¥Êñ∞
      const mappingListTitle = document.getElementById('mappingListTitle');
      if (mappingListTitle) mappingListTitle.textContent = lang.mappingListTitle;
      
      // AHK„Çπ„ÇØ„É™„Éó„Éà„Çø„Ç§„Éà„É´„ÇíÊõ¥Êñ∞
      const ahkScriptTitle = document.getElementById('ahkScriptTitle');
      if (ahkScriptTitle) ahkScriptTitle.textContent = lang.ahkScriptTitle;
      
      // „Éú„Çø„É≥„ÇíÊõ¥Êñ∞
      const downloadBtn = document.getElementById('downloadBtn');
      if (downloadBtn) downloadBtn.textContent = lang.downloadBtn;
      
      const saveBtn = document.getElementById('saveBtn');
      if (saveBtn) saveBtn.textContent = lang.saveBtn;
      
      const loadBtn = document.getElementById('loadBtn');
      if (loadBtn) loadBtn.childNodes[0].textContent = lang.loadBtn;
      
      const btnClearSelection = document.getElementById('btnClearSelection');
      if (btnClearSelection) btnClearSelection.textContent = lang.btnClearSelection;
      
      const btnClearAllMappings = document.getElementById('btnClearAllMappings');
      if (btnClearAllMappings) btnClearAllMappings.textContent = lang.btnClearAllMappings;
      
      // Êñ∞Ë¶è„É¨„Ç§„É§„Éº„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
      const addLayerBtn = document.getElementById('addLayerBtn');
      if (addLayerBtn) addLayerBtn.textContent = lang.addLayerBtn;
      
      // „Çπ„ÇØ„É™„Éó„Éà„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíÊõ¥Êñ∞Ôºà„Éû„ÉÉ„Éî„É≥„Ç∞„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
      const ahkOutput = document.getElementById('ahkOutput');
      if (ahkOutput && ahkOutput.textContent.includes('; „É¨„Ç§„É§„Éº„Ç≠„Éº„Éû„ÉÉ„Éó„Ç®„Éá„Ç£„Çø„ÅßÁîüÊàê„Åï„Çå„Åü„Çπ„ÇØ„É™„Éó„Éà') || 
          ahkOutput && ahkOutput.textContent.includes('; Script generated by Layer Keymap Editor')) {
        ahkOutput.textContent = lang.scriptPlaceholder;
      }
      
      // „É¨„Ç§„Ç¢„Ç¶„ÉàÈÅ∏Êäû„ÅÆÊõ¥Êñ∞
      const layoutSelect = document.getElementById('keyboardLayoutSelect');
      if (layoutSelect) {
        layoutSelect.options[0].text = lang.usLayout;
        layoutSelect.options[1].text = lang.jisLayout;
      }
    }


    init();
  
  </script>
</body>
</html>
